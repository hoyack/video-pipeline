---
phase: 13-llm-provider-abstraction-ollama
plan: 03
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - frontend/src/components/SettingsPage.tsx
  - frontend/src/components/GenerateForm.tsx
  - frontend/src/api/types.ts
  - frontend/src/api/client.ts
  - frontend/src/lib/constants.ts
autonomous: true
requirements:
  - LLMA-04
  - LLMA-05
  - LLMA-06

must_haves:
  truths:
    - "Settings page shows Ollama section with cloud/local toggle, API key input (cloud only), endpoint URL, and model management"
    - "Custom Ollama models can be added via text input, toggled on/off, and removed from the list"
    - "Added Ollama models appear in GenerateForm text_model and vision_model dropdowns when enabled"
    - "GenerateForm has a separate vision_model dropdown below text_model"
    - "Vision model dropdown shows both Gemini text models and enabled Ollama vision models"
    - "Saving settings persists Ollama config to backend and round-trips correctly"
  artifacts:
    - path: "frontend/src/components/SettingsPage.tsx"
      provides: "Ollama settings section with model management"
      contains: "ollama"
    - path: "frontend/src/components/GenerateForm.tsx"
      provides: "Vision model dropdown and Ollama model integration"
      contains: "vision_model"
    - path: "frontend/src/api/types.ts"
      provides: "Updated TypeScript types for Ollama settings and vision_model"
      contains: "ollama_models"
    - path: "frontend/src/api/client.ts"
      provides: "Updated API client functions"
      contains: "ollama"
  key_links:
    - from: "frontend/src/components/SettingsPage.tsx"
      to: "frontend/src/api/client.ts"
      via: "updateSettings() call with Ollama fields"
      pattern: "ollama_use_cloud"
    - from: "frontend/src/components/GenerateForm.tsx"
      to: "frontend/src/api/types.ts"
      via: "EnabledModelsResponse with ollama_models"
      pattern: "ollama_models"
    - from: "frontend/src/components/GenerateForm.tsx"
      to: "frontend/src/api/client.ts"
      via: "generateVideo() with vision_model field"
      pattern: "vision_model"
---

<objective>
Add Ollama settings UI to SettingsPage, model management, vision_model dropdown to GenerateForm, and update all frontend types and API client functions.

Purpose: Users can configure Ollama (local or cloud), manage custom model names, and select separate text and vision models per project. This completes the frontend integration for the LLM provider abstraction.
Output: Updated SettingsPage.tsx, GenerateForm.tsx, types.ts, client.ts, and constants.ts.
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-llm-provider-abstraction-ollama/13-RESEARCH.md
@.planning/phases/13-llm-provider-abstraction-ollama/13-01-SUMMARY.md
@frontend/src/components/SettingsPage.tsx
@frontend/src/components/GenerateForm.tsx
@frontend/src/api/types.ts
@frontend/src/api/client.ts
@frontend/src/lib/constants.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TypeScript types + API client + Ollama Settings UI</name>
  <files>
    frontend/src/api/types.ts
    frontend/src/api/client.ts
    frontend/src/components/SettingsPage.tsx
  </files>
  <action>
**types.ts** — Update interfaces:

1. Add to `GenerateRequest`:
   ```typescript
   vision_model?: string;
   ```

2. Add to `ProjectDetail` and `ProjectListItem`:
   ```typescript
   vision_model?: string | null;
   ```

3. Update `UserSettingsResponse` to add:
   ```typescript
   ollama_use_cloud: boolean;
   has_ollama_key: boolean;
   ollama_endpoint: string | null;
   ollama_models: OllamaModelEntry[] | null;
   ```

4. Update `UserSettingsUpdate` to add:
   ```typescript
   ollama_use_cloud?: boolean;
   ollama_api_key?: string | null;
   clear_ollama_key?: boolean;
   ollama_endpoint?: string | null;
   ollama_models?: OllamaModelEntry[] | null;
   ```

5. Update `EnabledModelsResponse` to add:
   ```typescript
   ollama_models: OllamaModelEntry[] | null;
   ```

6. Add new interface:
   ```typescript
   /** Ollama model entry stored in user settings */
   export interface OllamaModelEntry {
     id: string;       // e.g. "ollama/llama3.1"
     label: string;    // e.g. "Llama 3.1"
     enabled: boolean;
     vision: boolean;  // true if this model supports vision
   }
   ```

**client.ts** — No structural changes needed to client functions (they already pass through the request bodies). Verify that `generateVideo()` passes through `vision_model` from the GenerateRequest. If the function constructs the body manually (cherry-picking fields), add `vision_model` to the body.

**SettingsPage.tsx** — Add Ollama configuration section:

1. Add state variables after the ComfyUI state:
   ```typescript
   const [ollamaUseCloud, setOllamaUseCloud] = useState(false);
   const [ollamaApiKey, setOllamaApiKey] = useState("");
   const [hasOllamaKey, setHasOllamaKey] = useState(false);
   const [ollamaEndpoint, setOllamaEndpoint] = useState("");
   const [ollamaModels, setOllamaModels] = useState<OllamaModelEntry[]>([]);
   const [newModelName, setNewModelName] = useState("");
   ```

2. In the useEffect that loads settings, add:
   ```typescript
   setOllamaUseCloud(s.ollama_use_cloud);
   setHasOllamaKey(s.has_ollama_key);
   setOllamaEndpoint(s.ollama_endpoint ?? "");
   setOllamaModels(s.ollama_models ?? []);
   ```

3. In `handleSave()`, add to the updateSettings body:
   ```typescript
   ollama_use_cloud: ollamaUseCloud,
   ollama_api_key: ollamaApiKey || null,
   ollama_endpoint: ollamaEndpoint || null,
   ollama_models: ollamaModels,
   ```
   After save success, add:
   ```typescript
   setHasOllamaKey(res.has_ollama_key);
   setOllamaApiKey("");
   ```

4. Add Ollama configuration section in the JSX, AFTER the ComfyUI section and BEFORE the Feedback section. Follow the existing section styling pattern:

   ```tsx
   {/* Ollama Configuration */}
   <section className="space-y-4">
     <h2 className="text-lg font-semibold text-white">Ollama Configuration</h2>

     {/* Cloud vs Local toggle */}
     <div className="flex items-center gap-3">
       <span className="text-sm text-gray-300">Mode:</span>
       <button onClick={() => setOllamaUseCloud(false)}
         className={clsx("px-3 py-1 rounded text-sm", !ollamaUseCloud ? "bg-blue-600 text-white" : "bg-gray-700 text-gray-300")}>
         Local
       </button>
       <button onClick={() => setOllamaUseCloud(true)}
         className={clsx("px-3 py-1 rounded text-sm", ollamaUseCloud ? "bg-blue-600 text-white" : "bg-gray-700 text-gray-300")}>
         Cloud
       </button>
     </div>

     {/* API Key — only show in cloud mode */}
     {ollamaUseCloud && (
       <div>
         <label className="mb-1 block text-sm font-medium text-gray-300">API Key</label>
         <input type="password" value={ollamaApiKey}
           onChange={(e) => setOllamaApiKey(e.target.value)}
           placeholder={hasOllamaKey ? "Key is set (leave blank to keep)" : "Enter Ollama API key"}
           className="w-full rounded-lg border border-gray-700 bg-gray-900 px-3 py-2 text-sm text-gray-100 placeholder-gray-600 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
         />
         {hasOllamaKey && (
           <span className="mt-1 text-xs text-green-400">API key is set</span>
         )}
       </div>
     )}

     {/* Endpoint URL */}
     <div>
       <label className="mb-1 block text-sm font-medium text-gray-300">Endpoint URL</label>
       <input type="text" value={ollamaEndpoint}
         onChange={(e) => setOllamaEndpoint(e.target.value)}
         placeholder={ollamaUseCloud ? "https://ollama.com" : "http://localhost:11434"}
         className="w-full rounded-lg border border-gray-700 bg-gray-900 px-3 py-2 text-sm text-gray-100 placeholder-gray-600 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
       />
       <p className="mt-1 text-xs text-gray-500">
         Leave empty for default. Local: http://localhost:11434, Cloud: https://ollama.com
       </p>
     </div>

     {/* Model Management */}
     <div>
       <label className="mb-2 block text-sm font-medium text-gray-300">Models</label>
       <div className="flex gap-2 mb-3">
         <input type="text" value={newModelName}
           onChange={(e) => setNewModelName(e.target.value)}
           onKeyDown={(e) => e.key === "Enter" && handleAddOllamaModel()}
           placeholder="e.g. llama3.2-vision"
           className="flex-1 rounded-lg border border-gray-700 bg-gray-900 px-3 py-2 text-sm text-gray-100 placeholder-gray-600 focus:border-blue-500 focus:outline-none focus:ring-1 focus:ring-blue-500"
         />
         <button type="button" onClick={handleAddOllamaModel}
           className="rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-500">
           Add
         </button>
       </div>

       {/* Model list */}
       <div className="space-y-2">
         {ollamaModels.map((m) => (
           <div key={m.id} className="flex items-center justify-between rounded-lg border border-gray-800 bg-gray-900/50 px-4 py-2.5">
             <div className="flex items-center gap-3">
               <span className={clsx("text-sm font-medium", m.enabled ? "text-gray-200" : "text-gray-500")}>
                 {m.label}
               </span>
               <span className="text-xs text-gray-600">{m.id}</span>
               {/* Vision toggle */}
               <button type="button"
                 onClick={() => toggleOllamaModelVision(m.id)}
                 className={clsx("px-2 py-0.5 rounded text-xs",
                   m.vision ? "bg-purple-600/30 text-purple-300 border border-purple-600/50" : "bg-gray-800 text-gray-500"
                 )}>
                 vision
               </button>
             </div>
             <div className="flex items-center gap-2">
               {/* Enable/disable toggle */}
               <button type="button" onClick={() => toggleOllamaModelEnabled(m.id)}
                 className={clsx("relative inline-flex h-5 w-9 items-center rounded-full transition-colors",
                   m.enabled ? "bg-blue-600" : "bg-gray-700"
                 )}>
                 <span className={clsx("inline-block h-3 w-3 rounded-full bg-white transition-transform",
                   m.enabled ? "translate-x-5" : "translate-x-1"
                 )} />
               </button>
               {/* Remove button */}
               <button type="button" onClick={() => removeOllamaModel(m.id)}
                 className="text-xs text-red-400 hover:text-red-300">
                 Remove
               </button>
             </div>
           </div>
         ))}
         {ollamaModels.length === 0 && (
           <p className="text-xs text-gray-600 py-2">
             No Ollama models added. Type a model name above and click Add.
           </p>
         )}
       </div>
     </div>
   </section>
   ```

5. Add helper functions inside the component:
   ```typescript
   function handleAddOllamaModel() {
     const name = newModelName.trim();
     if (!name) return;
     const id = `ollama/${name}`;
     if (ollamaModels.some((m) => m.id === id)) return; // duplicate guard
     const label = name.split("/").pop() ?? name; // Use last segment as label
     // Auto-detect vision from name (heuristic: contains "vision" or "llava")
     const vision = /vision|llava/i.test(name);
     setOllamaModels([...ollamaModels, { id, label, enabled: true, vision }]);
     setNewModelName("");
   }

   function toggleOllamaModelEnabled(id: string) {
     setOllamaModels(ollamaModels.map((m) =>
       m.id === id ? { ...m, enabled: !m.enabled } : m
     ));
   }

   function toggleOllamaModelVision(id: string) {
     setOllamaModels(ollamaModels.map((m) =>
       m.id === id ? { ...m, vision: !m.vision } : m
     ));
   }

   function removeOllamaModel(id: string) {
     setOllamaModels(ollamaModels.filter((m) => m.id !== id));
   }
   ```

6. Import `OllamaModelEntry` from types.ts.
  </action>
  <verify>
1. `cd /home/ubuntu/work/video-pipeline/frontend && npx tsc --noEmit` — TypeScript compilation succeeds with no type errors.
2. Visual check: Settings page loads, Ollama section renders with cloud/local toggle, model input, and empty state message.
  </verify>
  <done>
SettingsPage shows Ollama Configuration section with cloud/local toggle (local hides API key), endpoint URL, and model management (add/remove/toggle/vision badge). All Ollama settings save to backend. TypeScript types updated for OllamaModelEntry, vision_model, and Ollama settings fields.
  </done>
</task>

<task type="auto">
  <name>Task 2: GenerateForm vision_model dropdown + Ollama model integration</name>
  <files>
    frontend/src/components/GenerateForm.tsx
    frontend/src/lib/constants.ts
  </files>
  <action>
**GenerateForm.tsx** — Add vision_model dropdown and merge Ollama models:

1. Add state: `const [visionModel, setVisionModel] = useState<string>("");` (empty string = "Same as text model" / not set)

2. Build combined model lists using Ollama models from settings:
   ```typescript
   // Merge Ollama text models (enabled, any) into text model list
   const allTextModels = useMemo(() => {
     const base = filteredTextModels;
     const ollamaText = (modelSettings?.ollama_models ?? [])
       .filter((m) => m.enabled)
       .map((m) => ({ id: m.id, label: `${m.label} (Ollama)`, costPerCall: 0 }));
     return [...base, ...ollamaText];
   }, [filteredTextModels, modelSettings]);

   // Vision models: Gemini text models (they all support vision) + Ollama vision models
   const allVisionModels = useMemo(() => {
     const base = filteredTextModels; // Gemini text models work for vision too
     const ollamaVision = (modelSettings?.ollama_models ?? [])
       .filter((m) => m.enabled && m.vision)
       .map((m) => ({ id: m.id, label: `${m.label} (Ollama)`, costPerCall: 0 }));
     return [...base, ...ollamaVision];
   }, [filteredTextModels, modelSettings]);
   ```

3. Replace the existing Text Model button group to use `allTextModels` instead of `filteredTextModels`:
   ```tsx
   {allTextModels.map((m) => (
     <button key={m.id} type="button" onClick={() => setTextModel(m.id)}
       className={clsx(/* existing classes */)}
     >
       {m.label}
     </button>
   ))}
   ```

4. Add Vision Model section AFTER the Text Model section (before Image Model):
   ```tsx
   {/* Vision Model */}
   <div>
     <label className="mb-2 block text-sm font-medium text-gray-300">
       Vision Model
       <span className="ml-2 text-xs text-gray-500 font-normal">
         For image analysis, reverse-prompting, and scoring
       </span>
     </label>
     <div className="flex flex-wrap gap-2">
       <button
         type="button"
         onClick={() => setVisionModel("")}
         className={clsx(
           "rounded-md border px-3 py-1.5 text-sm font-medium transition-colors",
           visionModel === ""
             ? "border-blue-500 bg-blue-500/20 text-blue-300"
             : "border-gray-700 bg-gray-900 text-gray-400 hover:border-gray-600",
         )}
       >
         Same as Text
       </button>
       {allVisionModels.map((m) => (
         <button
           key={m.id}
           type="button"
           onClick={() => setVisionModel(m.id)}
           className={clsx(
             "rounded-md border px-3 py-1.5 text-sm font-medium transition-colors",
             visionModel === m.id
               ? "border-blue-500 bg-blue-500/20 text-blue-300"
               : "border-gray-700 bg-gray-900 text-gray-400 hover:border-gray-600",
           )}
         >
           {m.label}
         </button>
       ))}
     </div>
   </div>
   ```

5. In `handleSubmit()`, add `vision_model` to the generateVideo call:
   ```typescript
   vision_model: visionModel || undefined,  // undefined = omitted from JSON = use text_model
   ```

6. Ensure the selected models are still valid after Ollama models change. Add to the existing useEffect that validates selected models:
   ```typescript
   if (visionModel && allVisionModels.length > 0 && !allVisionModels.find((m) => m.id === visionModel)) {
     setVisionModel("");
   }
   ```

7. Update the useEffect that applies defaults from settings: if `modelSettings` has a default text model from Ollama, it should work since `allTextModels` includes Ollama entries.

**constants.ts** — No changes needed. Ollama models are dynamic from DB, not static catalog entries. The `estimateCost` function already handles unknown model IDs gracefully (defaults to 0 for cost).
  </action>
  <verify>
1. `cd /home/ubuntu/work/video-pipeline/frontend && npx tsc --noEmit` — TypeScript compilation succeeds with no type errors.
2. Visual check: GenerateForm shows Text Model buttons (including any enabled Ollama models), Vision Model section with "Same as Text" default + model buttons, and existing UI unchanged.
  </verify>
  <done>
GenerateForm has a Vision Model dropdown with "Same as Text" default option. Enabled Ollama text models appear in the Text Model button group. Enabled Ollama vision models appear in the Vision Model button group. vision_model field is sent in GenerateRequest when user selects a specific vision model. Cost estimation works for all model types.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles with zero errors
2. SettingsPage Ollama section renders correctly with all controls
3. Adding an Ollama model in settings makes it appear in GenerateForm dropdowns
4. Toggling cloud mode shows/hides API key field
5. Vision model selection sends correct value in GenerateRequest
6. "Same as Text" option sends undefined/omitted vision_model (backend uses fallback chain)
</verification>

<success_criteria>
- Settings page has complete Ollama section (toggle, key, endpoint, model management)
- Models added in settings appear in GenerateForm text and vision dropdowns
- GenerateForm has vision_model selector with "Same as Text" default
- All TypeScript types updated and compilation clean
- Settings round-trip through API correctly
</success_criteria>

<output>
After completion, create `.planning/phases/13-llm-provider-abstraction-ollama/13-03-SUMMARY.md`
</output>
