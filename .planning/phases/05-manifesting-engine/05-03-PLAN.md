---
phase: 05-manifesting-engine
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - frontend/src/components/ManifestCreator.tsx
  - frontend/src/api/types.ts
  - frontend/src/api/client.ts
autonomous: true

must_haves:
  truths:
    - "User can click Process button in ManifestCreator to trigger manifesting on a DRAFT manifest"
    - "Processing progress displays live with step label, uploads processed counter, and crops reverse-prompted counter"
    - "When processing completes, extracted assets appear in the asset list with reverse prompts, quality scores, and detection metadata"
    - "User can edit reverse_prompt and visual_description inline on any asset (Stage 3 review)"
    - "User can click Re-process on a single asset to re-run detection and reverse-prompting"
    - "User can remove (delete) individual assets from the manifest"
    - "ManifestCreator shows different UI based on manifest status: DRAFT=Stage 1, PROCESSING=Stage 2, READY=Stage 3"
  artifacts:
    - path: "frontend/src/components/ManifestCreator.tsx"
      provides: "Stage 2 processing progress + Stage 3 review/refine UI"
      min_lines: 200
    - path: "frontend/src/api/types.ts"
      provides: "Updated AssetResponse with Phase 5 fields + ProcessingProgress type"
      contains: "reverse_prompt"
    - path: "frontend/src/api/client.ts"
      provides: "processManifest, getProcessingProgress, reprocessAsset API functions"
      contains: "processManifest"
  key_links:
    - from: "frontend/src/components/ManifestCreator.tsx"
      to: "frontend/src/api/client.ts"
      via: "processManifest + getProcessingProgress + reprocessAsset calls"
      pattern: "processManifest|getProcessingProgress|reprocessAsset"
    - from: "frontend/src/api/client.ts"
      to: "/api/manifests/{id}/process"
      via: "fetch POST"
      pattern: "manifests.*process"
    - from: "frontend/src/api/client.ts"
      to: "/api/manifests/{id}/progress"
      via: "fetch GET polling"
      pattern: "manifests.*progress"
---

<objective>
Add Creator Stages 2 and 3 to the ManifestCreator component: processing progress UI with polling (Stage 2) and review/refine interface with inline editing of reverse prompts, reprocessing, and asset removal (Stage 3).

Purpose: Users can trigger manifesting, watch it process, then review and refine the auto-generated asset descriptions.
Output: Complete ManifestCreator supporting all 3 stages (upload -> process -> review).
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-manifesting-engine/05-RESEARCH.md
@.planning/phases/05-manifesting-engine/05-01-SUMMARY.md
@.planning/phases/05-manifesting-engine/05-02-SUMMARY.md
@frontend/src/components/ManifestCreator.tsx
@frontend/src/api/types.ts
@frontend/src/api/client.ts
@frontend/src/components/AssetEditor.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update TypeScript types and API client for processing</name>
  <files>frontend/src/api/types.ts, frontend/src/api/client.ts</files>
  <action>
**1. Update `frontend/src/api/types.ts`:**

Update `AssetResponse` interface to include Phase 5 fields:
```typescript
export interface AssetResponse {
  // ... existing fields ...
  asset_id: string;
  manifest_id: string;
  asset_type: string;
  name: string;
  manifest_tag: string;
  user_tags: string[] | null;
  reference_image_url: string | null;
  thumbnail_url: string | null;
  description: string | null;
  source: string;
  sort_order: number;
  created_at: string;
  // Phase 5 fields
  reverse_prompt: string | null;
  visual_description: string | null;
  detection_class: string | null;
  detection_confidence: number | null;
  is_face_crop: boolean;
  quality_score: number | null;
}
```

Add new `ProcessingProgress` interface:
```typescript
export interface ProcessingProgress {
  status: "processing" | "complete" | "error" | "not_started";
  current_step: string | null;
  progress: {
    uploads_total?: number;
    uploads_processed?: number;
    crops_total?: number;
    crops_reverse_prompted?: number;
    face_merges?: number;
  } | null;
  error: string | null;
}
```

Add UpdateAssetRequest fields for Phase 5 editing:
```typescript
export interface UpdateAssetRequest {
  // ... existing fields ...
  reverse_prompt?: string;
  visual_description?: string;
}
```

**2. Update `frontend/src/api/client.ts`:**

Add 3 new functions:

```typescript
/** POST /api/manifests/{id}/process -- trigger background processing */
export function processManifest(manifestId: string): Promise<{ task_id: string; status: string }> {
  return request<{ task_id: string; status: string }>(`/api/manifests/${manifestId}/process`, {
    method: "POST",
  });
}

/** GET /api/manifests/{id}/progress -- poll processing progress */
export function getProcessingProgress(manifestId: string): Promise<ProcessingProgress> {
  return request<ProcessingProgress>(`/api/manifests/${manifestId}/progress`);
}

/** POST /api/assets/{id}/reprocess -- re-run detection + reverse-prompting for single asset */
export function reprocessAsset(assetId: string): Promise<AssetResponse> {
  return request<AssetResponse>(`/api/assets/${assetId}/reprocess`, {
    method: "POST",
  });
}
```

Add the ProcessingProgress import to the type imports at the top of client.ts.
  </action>
  <verify>
Run: `cd /home/ubuntu/work/video-pipeline/frontend && npx tsc --noEmit 2>&1 | head -20` -- should show zero type errors (or only pre-existing ones unrelated to this change).
  </verify>
  <done>TypeScript types updated with Phase 5 AssetResponse fields and ProcessingProgress interface. Three new API client functions added (processManifest, getProcessingProgress, reprocessAsset).</done>
</task>

<task type="auto">
  <name>Task 2: Implement ManifestCreator Stage 2 (processing progress) and Stage 3 (review/refine)</name>
  <files>frontend/src/components/ManifestCreator.tsx</files>
  <action>
Rewrite ManifestCreator to support all three stages. The component should detect the manifest's current status and render the appropriate stage.

**Stage detection logic:**
- If manifest is null or status === "DRAFT": Show Stage 1 (existing upload + tag UI)
- If status === "PROCESSING": Show Stage 2 (progress UI)
- If status === "READY" or status === "ERROR": Show Stage 3 (review/refine)

**Stage 1 (keep existing):**
The current upload + tag functionality remains. Add a "Process" button that appears when there are assets and manifest status is DRAFT. Clicking it calls `processManifest(manifestId)`, then sets local status to "PROCESSING" to transition to Stage 2.

**Stage 2 (NEW - processing progress):**
Poll `getProcessingProgress(manifestId)` every 1.5 seconds via setInterval in useEffect. Display:
- Current step label (map step strings to human labels):
  - "contact_sheet" -> "Assembling contact sheet..."
  - "yolo_detection" -> "Detecting objects and faces..."
  - "face_matching" -> "Cross-matching faces..."
  - "reverse_prompting" -> "Generating asset descriptions..."
  - "finalizing" -> "Assigning tags and populating registry..."
  - "done" -> "Processing complete!"
- Spinner animation (Tailwind: animate-spin border-2 border-blue-500 border-t-transparent rounded-full)
- Progress bars:
  - "Images processed: N / M" with blue progress bar
  - "Assets described: N / M" with green progress bar (only show when crops_total > 0)
- On status === "complete": clear interval, reload manifest detail (call getManifestDetail), transition to Stage 3
- On status === "error": clear interval, show error message with red styling, show "Retry" button that calls processManifest again
- Clean up interval on unmount (useEffect return function)

**Stage 3 (NEW - review/refine):**
Display all assets in an enhanced list. For each asset show:
- Image thumbnail (from reference_image_url)
- Name (editable inline, on-blur update via updateAsset)
- Manifest tag badge (e.g., "CHAR_01" in a small pill)
- Asset type dropdown (editable)
- Quality score badge: colored based on value (green >= 7, yellow 4-7, red < 4)
- Detection info: detection_class + confidence (small gray text)
- Source badge: "uploaded" vs "extracted" (extracted assets show in slightly different style)
- Reverse prompt: shown in a collapsible textarea. Click "Edit" to enable editing. On blur, save via updateAsset.
- Visual description: same pattern - collapsible, editable textarea.
- Action buttons per asset:
  - "Re-process" button: calls reprocessAsset(assetId), shows spinner while processing, updates asset in list on success
  - "Remove" button: calls deleteAsset(assetId), removes from list with confirmation

Show a summary bar at bottom:
- Total assets count with breakdown by type
- Face merges count (from processing progress if available)
- "Reprocess All" button that calls processManifest again (resets to Stage 2)
- "Done" button that calls onSaved

**Styling:** Follow existing dark theme (gray-900/gray-800 backgrounds, blue-400 accents). Use Tailwind classes consistent with existing components (ManifestCard, AssetEditor).

**Important state management:**
- Use `manifest.status` as source of truth for stage
- After process completes, re-fetch manifest to get updated status and assets
- Keep optimistic updates for inline edits (update local state immediately, fire API in background)
- Handle the case where user navigates to creator with an already-PROCESSING manifest (resume Stage 2 polling)
- Handle the case where user navigates with a READY manifest (show Stage 3 directly)
  </action>
  <verify>
Run: `cd /home/ubuntu/work/video-pipeline/frontend && npx tsc --noEmit 2>&1 | head -20` -- should show zero type errors.
Run: `cd /home/ubuntu/work/video-pipeline/frontend && npm run build 2>&1 | tail -5` -- should succeed.
  </verify>
  <done>ManifestCreator supports all 3 stages. Stage 1 has Process button. Stage 2 shows live polling progress with step labels and progress bars. Stage 3 shows review/refine with editable reverse prompts, quality scores, reprocess per asset, and remove per asset. Stage transitions happen automatically based on manifest status.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete ManifestCreator with Stage 1 (upload), Stage 2 (processing progress), and Stage 3 (review/refine). Backend manifesting engine with YOLO detection, ArcFace face matching, Gemini reverse-prompting, and contact sheet assembly.</what-built>
  <how-to-verify>
1. Start backend: `cd /home/ubuntu/work/video-pipeline && python -m vidpipe.api`
2. Start frontend: `cd /home/ubuntu/work/video-pipeline/frontend && npm run dev`
3. Navigate to Manifests tab
4. Click "+ New Manifest"
5. Name the manifest "Test Characters"
6. Drop 2-3 images into the upload zone
7. Verify images appear with thumbnails and type dropdowns (Stage 1)
8. Click "Process" button
9. Verify Stage 2 shows:
   - Step labels updating (contact sheet -> YOLO -> face matching -> reverse prompting -> finalizing)
   - Progress bars animating
   - Spinner visible
10. Wait for processing to complete (should be 30-120 seconds depending on images)
11. Verify Stage 3 shows:
    - All assets listed (original uploads + any extracted crops)
    - Each asset shows reverse_prompt text, quality score badge, manifest tag
    - Contact sheet URL is set on manifest
12. Try editing a reverse_prompt inline and verify it saves
13. Try clicking "Re-process" on one asset
14. Try clicking "Remove" on one asset

If YOLO/InsightFace models are not installed yet (first run), the processing may fail or take extra time to download models. This is expected on first run.
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Frontend builds successfully
3. ManifestCreator renders Stage 1 for DRAFT manifests
4. ManifestCreator renders Stage 2 for PROCESSING manifests with live progress
5. ManifestCreator renders Stage 3 for READY manifests with editable fields
6. processManifest, getProcessingProgress, reprocessAsset client functions exist
7. AssetResponse includes reverse_prompt, visual_description, quality_score, detection_class, detection_confidence, is_face_crop
</verification>

<success_criteria>
- User can upload images, trigger processing, watch progress, and review results entirely in the ManifestCreator UI
- Reverse prompts are editable inline
- Single asset reprocessing works from the UI
- Asset removal works from the UI
- Stage transitions happen automatically based on manifest status
- Polling stops when processing completes or errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-manifesting-engine/05-03-SUMMARY.md`
</output>
