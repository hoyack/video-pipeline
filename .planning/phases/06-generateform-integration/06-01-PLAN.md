---
phase: 06-generateform-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/vidpipe/db/models.py
  - backend/vidpipe/services/manifest_service.py
  - backend/vidpipe/api/routes.py
  - backend/vidpipe/orchestrator/pipeline.py
autonomous: true

must_haves:
  truths:
    - "POST /api/generate with manifest_id creates a ManifestSnapshot and increments usage tracking"
    - "POST /api/generate without manifest_id works exactly as before (no regression)"
    - "Pipeline skips manifesting and starts at storyboarding when project has manifest_id"
    - "Pipeline runs manifesting when project has no manifest_id (quick upload path unchanged)"
    - "ManifestSnapshot contains full serialized manifest + assets JSON frozen at generation time"
    - "Manifest times_used increments and last_used_at updates when selected for generation"
  artifacts:
    - path: "backend/vidpipe/db/models.py"
      provides: "ManifestSnapshot ORM model"
      contains: "class ManifestSnapshot"
    - path: "backend/vidpipe/services/manifest_service.py"
      provides: "create_snapshot and increment_usage functions"
      contains: "async def create_snapshot"
    - path: "backend/vidpipe/api/routes.py"
      provides: "Enhanced GenerateRequest with optional manifest_id"
      contains: "manifest_id"
    - path: "backend/vidpipe/orchestrator/pipeline.py"
      provides: "Conditional manifesting skip when manifest_id present"
      contains: "manifest_id"
  key_links:
    - from: "backend/vidpipe/api/routes.py"
      to: "backend/vidpipe/services/manifest_service.py"
      via: "create_snapshot + increment_usage calls in generate_video"
      pattern: "manifest_service\\.create_snapshot|manifest_service\\.increment_usage"
    - from: "backend/vidpipe/orchestrator/pipeline.py"
      to: "backend/vidpipe/db/models.py"
      via: "project.manifest_id check to skip manifesting"
      pattern: "project\\.manifest_id"
---

<objective>
Add ManifestSnapshot database model, snapshot creation service, usage tracking, enhanced generate endpoint with optional manifest_id, and conditional pipeline manifesting skip.

Purpose: Backend foundation for Phase 6 — enables projects to reference pre-built manifests with immutable snapshots, skip manifesting when appropriate, and track manifest usage.
Output: All backend changes needed for manifest-aware generation.
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@backend/vidpipe/db/models.py
@backend/vidpipe/services/manifest_service.py
@backend/vidpipe/api/routes.py
@backend/vidpipe/orchestrator/pipeline.py
@.planning/phases/06-generateform-integration/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: ManifestSnapshot model, snapshot service, and usage tracking</name>
  <files>
    backend/vidpipe/db/models.py
    backend/vidpipe/services/manifest_service.py
  </files>
  <action>
1. Add ManifestSnapshot model to `backend/vidpipe/db/models.py`:
   ```python
   class ManifestSnapshot(Base):
       __tablename__ = "manifest_snapshots"
       id: Mapped[uuid.UUID] = mapped_column(primary_key=True, default=uuid.uuid4)
       manifest_id: Mapped[uuid.UUID] = mapped_column(ForeignKey("manifests.id"), index=True)
       project_id: Mapped[uuid.UUID] = mapped_column(ForeignKey("projects.id"), index=True)
       version_at_snapshot: Mapped[int] = mapped_column(Integer)
       snapshot_data: Mapped[dict] = mapped_column(JSON)  # Full manifest + assets serialized
       created_at: Mapped[datetime] = mapped_column(server_default=func.now())
   ```
   Place it after the Asset class and before the Project class (or after Project — order doesn't matter for SQLAlchemy, but group manifest-related models together).

2. Add two new functions to `backend/vidpipe/services/manifest_service.py`:

   a. `create_snapshot(session, manifest_id, project_id)` -> ManifestSnapshot:
      - Query manifest by ID (must exist, must not be deleted)
      - Query all assets for that manifest via `list_assets(session, manifest_id)`
      - Serialize manifest fields (id, name, description, category, tags, contact_sheet_url, version, status, asset_count, total_processing_cost) into snapshot_data["manifest"]
      - Serialize each asset (id, asset_type, name, manifest_tag, user_tags, reference_image_url, thumbnail_url, description, source, sort_order, reverse_prompt, visual_description, detection_class, detection_confidence, is_face_crop, crop_bbox, quality_score) into snapshot_data["assets"] list
      - Convert all uuid.UUID values to str in the serialization
      - Create ManifestSnapshot with manifest_id, project_id, version_at_snapshot=manifest.version, snapshot_data
      - session.add() and session.flush() (caller commits)
      - Return snapshot

   b. `increment_usage(session, manifest_id)` -> None:
      - Query manifest by ID
      - Increment manifest.times_used by 1
      - Set manifest.last_used_at to datetime.now(timezone.utc)
      - session.flush() (caller commits)
      - Import datetime and timezone from datetime module at top of file

   Import ManifestSnapshot from vidpipe.db.models in manifest_service.py.
  </action>
  <verify>
    - `python -c "from vidpipe.db.models import ManifestSnapshot; print('ManifestSnapshot imported OK')"` succeeds
    - `python -c "from vidpipe.services.manifest_service import create_snapshot, increment_usage; print('Functions imported OK')"` succeeds
    - ManifestSnapshot has all 6 columns (id, manifest_id, project_id, version_at_snapshot, snapshot_data, created_at)
  </verify>
  <done>
    ManifestSnapshot model exists with proper columns and foreign keys. create_snapshot serializes manifest + all assets into JSON. increment_usage updates times_used and last_used_at.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhanced generate endpoint and conditional pipeline skip</name>
  <files>
    backend/vidpipe/api/routes.py
    backend/vidpipe/orchestrator/pipeline.py
  </files>
  <action>
1. In `backend/vidpipe/api/routes.py`:

   a. Add `manifest_id: Optional[str] = None` to the GenerateRequest schema.

   b. In the `generate_video` endpoint, after creating the project record and before `await session.commit()`:
      - If `request.manifest_id` is provided:
        - Validate manifest exists: query Manifest by UUID, raise 404 if not found or deleted
        - Set `project.manifest_id = uuid.UUID(request.manifest_id)`
        - Set `project.manifest_version` to manifest.version
        - Call `await manifest_service.create_snapshot(session, uuid.UUID(request.manifest_id), project.id)`
        - Call `await manifest_service.increment_usage(session, uuid.UUID(request.manifest_id))`
        - Log: `logger.info(f"Project {project_id} using manifest {request.manifest_id}, snapshot created")`
      - Note: need to `await session.flush()` after adding project (before snapshot creation) to get project.id

   c. Import ManifestSnapshot is not needed in routes.py (service handles it), but ensure manifest_service import is already there (it is).

2. In `backend/vidpipe/orchestrator/pipeline.py`:

   a. Add conditional manifesting skip in `run_pipeline`. Currently the pipeline has 4 steps: storyboard (pending), keyframes (keyframing), video_gen, stitching. Phase 0 (manifesting) is not yet a step in the pipeline state machine. The design says: if project.manifest_id is set, skip manifesting and go straight to storyboarding. If project.manifest_id is NOT set, the existing behavior applies (no manifesting step exists yet — that comes in a future phase for inline quick upload).

   Since manifesting is not yet implemented in the pipeline (Phase 5 only implemented the standalone ManifestCreator flow, not inline pipeline manifesting), the conditional skip for Phase 6 means:
   - When manifest_id IS set: pipeline runs normally (pending -> storyboarding -> keyframing -> video_gen -> stitching -> complete). The manifest's assets are already processed and available via the snapshot.
   - When manifest_id is NOT set: pipeline runs normally (same flow — manifesting step doesn't exist yet in the pipeline).

   Therefore, no changes are needed to pipeline.py at this time. The conditional skip becomes relevant in Phase 7+ when the pipeline gains a manifesting step. Document this with a comment in the generate_video endpoint:
   ```python
   # Note: Conditional manifesting skip (Phase 6 success criteria #5) is achieved
   # by the presence of manifest_id on the project. When manifest_id is set, the
   # pipeline knows assets are pre-processed (snapshot exists). The pipeline's
   # manifesting step (to be added in Phase 7+) will check project.manifest_id
   # and skip if present. For now, the pipeline has no manifesting step, so the
   # skip is implicit — pre-built manifests just bypass the need for one.
   ```

   b. However, add a comment block at the top of `run_pipeline` documenting the future manifesting integration point:
   ```python
   # Phase 6: If project.manifest_id is set, manifesting is skipped
   # (assets already processed via ManifestSnapshot). When a manifesting
   # pipeline step is added (Phase 7+), check project.manifest_id here
   # and skip the manifesting step if present.
   ```
  </action>
  <verify>
    - `cd /home/ubuntu/work/video-pipeline && python -c "from vidpipe.api.routes import GenerateRequest; r = GenerateRequest(prompt='test'); print('manifest_id:', r.manifest_id)"` prints `manifest_id: None`
    - `cd /home/ubuntu/work/video-pipeline && python -c "from vidpipe.api.routes import GenerateRequest; r = GenerateRequest(prompt='test', manifest_id='abc'); print('manifest_id:', r.manifest_id)"` prints `manifest_id: abc`
    - grep for "manifest_id" in routes.py generate_video function confirms snapshot creation and usage tracking calls
    - grep for "manifest_id" comment in pipeline.py confirms documentation of future skip point
  </verify>
  <done>
    GenerateRequest accepts optional manifest_id. generate_video validates manifest, creates snapshot, and increments usage when manifest_id provided. Pipeline.py documents the manifesting skip integration point. Existing generate flow without manifest_id is unchanged (no regression).
  </done>
</task>

</tasks>

<verification>
1. Import check: `python -c "from vidpipe.db.models import ManifestSnapshot; from vidpipe.services.manifest_service import create_snapshot, increment_usage; from vidpipe.api.routes import GenerateRequest; print('All imports OK')"`
2. Schema check: GenerateRequest with manifest_id=None works (backward compatible)
3. GenerateRequest with manifest_id='some-uuid' works (new behavior)
4. ManifestSnapshot model has correct ForeignKey relationships
5. No changes break existing generate endpoint behavior (manifest_id is Optional with default None)
</verification>

<success_criteria>
- ManifestSnapshot ORM model exists with id, manifest_id, project_id, version_at_snapshot, snapshot_data, created_at
- create_snapshot function serializes manifest + all assets into snapshot_data JSON
- increment_usage function updates times_used and last_used_at
- GenerateRequest accepts optional manifest_id parameter
- generate_video endpoint creates snapshot and increments usage when manifest_id provided
- generate_video endpoint works unchanged when manifest_id is not provided
- Pipeline has documentation for future manifesting skip integration
</success_criteria>

<output>
After completion, create `.planning/phases/06-generateform-integration/06-01-SUMMARY.md`
</output>
