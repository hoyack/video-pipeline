---
phase: 08-veo-reference-passthrough-and-clean-sheets
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - backend/vidpipe/pipeline/video_gen.py
  - backend/vidpipe/services/clean_sheet_service.py
autonomous: true

must_haves:
  truths:
    - "Video generation passes up to 3 reference images to Veo 3.1 when project has a manifest"
    - "Duration is forced to 8 seconds when reference images are attached"
    - "First-frame daisy-chain (image param) and reference images (referenceImages param) work together in hybrid mode"
    - "Selected reference tags are persisted to SceneManifest.selected_reference_tags for debugging/UI"
    - "Clean sheet Tier 2 (rembg background removal) generates clean reference on neutral gray background"
    - "Clean sheet Tier 3 (Gemini Image) generates idealized reference with face similarity validation"
    - "Clean sheets stored in asset_clean_references table, never overwrite original Asset.reference_image_url"
    - "Projects without manifest_id continue to work unchanged (backward compatibility)"
  artifacts:
    - path: "backend/vidpipe/pipeline/video_gen.py"
      provides: "Enhanced _submit_video_job with reference_images parameter and 8s duration enforcement"
      contains: "reference_images"
    - path: "backend/vidpipe/services/clean_sheet_service.py"
      provides: "Tier 2 and Tier 3 clean sheet generation with validation"
      exports: ["generate_tier2_clean_sheet", "generate_tier3_clean_sheet"]
  key_links:
    - from: "backend/vidpipe/pipeline/video_gen.py"
      to: "backend/vidpipe/services/reference_selection.py"
      via: "select_references_for_scene call"
      pattern: "select_references_for_scene"
    - from: "backend/vidpipe/pipeline/video_gen.py"
      to: "backend/vidpipe/services/reference_selection.py"
      via: "get_primary_clean_reference for clean sheet override"
      pattern: "get_primary_clean_reference"
    - from: "backend/vidpipe/services/clean_sheet_service.py"
      to: "backend/vidpipe/db/models.py"
      via: "creates AssetCleanReference records"
      pattern: "AssetCleanReference"
---

<objective>
Enhance the video generation pipeline to pass up to 3 reference images per scene to Veo 3.1 for identity consistency, and implement clean sheet generation services (Tier 2: rembg, Tier 3: Gemini Image) for reference quality optimization.

Purpose: This is the core pipeline integration that enables character/object identity preservation across scenes.
Output: Enhanced video_gen.py with reference passthrough, clean_sheet_service.py with Tier 2/3 generation.
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-veo-reference-passthrough-and-clean-sheets/08-RESEARCH.md
@.planning/phases/08-veo-reference-passthrough-and-clean-sheets/08-01-SUMMARY.md
@backend/vidpipe/pipeline/video_gen.py
@backend/vidpipe/db/models.py
@backend/vidpipe/services/manifest_service.py
@backend/vidpipe/services/vertex_client.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance video_gen.py with reference image passthrough and 8-second duration enforcement</name>
  <files>backend/vidpipe/pipeline/video_gen.py</files>
  <action>
Modify `_generate_video_for_scene` in video_gen.py to load scene manifest, select references, and pass them to Veo 3.1.

Changes to `_generate_video_for_scene`:

1. After loading keyframes, add reference selection logic:

```python
# Load scene manifest and select references (Phase 8)
from vidpipe.db.models import SceneManifest as SceneManifestModel
from vidpipe.services.reference_selection import select_references_for_scene, get_primary_clean_reference

selected_refs = []
if project.manifest_id:
    # Query scene manifest
    sm_result = await session.execute(
        select(SceneManifestModel).where(
            SceneManifestModel.project_id == project.id,
            SceneManifestModel.scene_index == scene.scene_index
        )
    )
    scene_manifest_row = sm_result.scalar_one_or_none()

    if scene_manifest_row and scene_manifest_row.manifest_json:
        # Load all manifest assets
        all_assets = await manifest_service.load_manifest_assets(session, project.manifest_id)
        selected_refs = select_references_for_scene(
            scene_manifest_row.manifest_json,
            all_assets
        )

        # Persist selected tags for debugging and UI display
        if selected_refs:
            scene_manifest_row.selected_reference_tags = [r.manifest_tag for r in selected_refs]
            await session.commit()

    logger.info(
        f"Scene {scene.scene_index}: selected {len(selected_refs)} reference(s): "
        f"{[r.manifest_tag for r in selected_refs]}"
    )
```

2. Modify `_submit_video_job` to accept an optional `reference_images` parameter:

Change signature to:
```python
async def _submit_video_job(
    client,
    video_model: str,
    video_prompt: str,
    start_frame_bytes: bytes,
    end_frame_bytes: bytes,
    project: Project,
    reference_images: Optional[list[types.ReferenceImage]] = None,
):
```

Inside `_submit_video_job`, AFTER creating video_config and BEFORE the return statement:
- If `reference_images` is non-empty, set `video_config.reference_images = reference_images`
- CRITICAL: If reference_images is non-empty, override `duration_seconds = 8` regardless of project.target_clip_duration. This is a Veo 3.1 API constraint (8s mandatory with references).
- Log when duration is overridden: `logger.info(f"Duration overridden to 8s (reference images attached)")`

3. In `_generate_video_for_scene`, build the reference_images list before calling `_submit_video_job`:

```python
# Build Veo reference images list (Phase 8)
veo_ref_images = None
if selected_refs:
    veo_ref_images = []
    for asset in selected_refs:
        # Check for clean sheet override
        clean_ref = await get_primary_clean_reference(session, asset.id)
        img_url = clean_ref.clean_image_url if clean_ref else asset.reference_image_url

        if img_url:
            # Read image bytes (local file paths)
            ref_bytes = Path(img_url).read_bytes()
            veo_ref_images.append(
                types.ReferenceImage(
                    reference_image=types.Image(
                        image_bytes=ref_bytes,
                        mime_type="image/png"
                    ),
                    reference_type="asset"
                )
            )

    if not veo_ref_images:
        veo_ref_images = None  # No valid images found
```

4. Pass `reference_images=veo_ref_images` to `_submit_video_job` call.

5. Update the `clip.duration_seconds` assignment after polling success to use the actual duration (8 if refs used, else project.target_clip_duration):
```python
clip.duration_seconds = 8 if selected_refs else project.target_clip_duration
```

Important: Add `from vidpipe.services import manifest_service` import at top of file. Keep all existing content-policy remediation logic unchanged. The reference images are passed on ALL escalation levels (level 0, 1, 2) -- identity references don't change with safety prefixes.

Backward compatibility: When `project.manifest_id` is None or scene_manifest doesn't exist, `selected_refs` stays empty and behavior is identical to current code.
  </action>
  <verify>
Run: `python -c "from vidpipe.pipeline.video_gen import _submit_video_job, generate_videos; import inspect; sig = inspect.signature(_submit_video_job.__wrapped__); print('reference_images param:', 'reference_images' in sig.parameters); print('OK')"` -- confirms new parameter exists.

Run: `grep -c 'reference_images' backend/vidpipe/pipeline/video_gen.py` -- should show multiple occurrences (parameter, config assignment, duration override).

Run: `grep 'duration_seconds.*8' backend/vidpipe/pipeline/video_gen.py` -- confirms 8-second override logic exists.

Run: `grep 'selected_reference_tags' backend/vidpipe/pipeline/video_gen.py` -- confirms persistence of selected tags.
  </verify>
  <done>video_gen.py passes up to 3 reference images to Veo 3.1, enforces 8-second duration when references attached, persists selected_reference_tags to SceneManifest, and maintains full backward compatibility for non-manifest projects.</done>
</task>

<task type="auto">
  <name>Task 2: Create clean sheet generation service with Tier 2 (rembg) and Tier 3 (Gemini Image)</name>
  <files>backend/vidpipe/services/clean_sheet_service.py</files>
  <action>
Create new file `backend/vidpipe/services/clean_sheet_service.py` implementing Tier 2 and Tier 3 clean sheet generation.

Module docstring: "Clean sheet generation service for reference image preprocessing. Tier 2: local background removal via rembg. Tier 3: full clean sheet via Gemini Image with face similarity validation."

**Function 1: `async generate_tier2_clean_sheet(session, asset, manifest_id) -> str`**

- Load original image bytes from `asset.reference_image_url` (local Path)
- Run `rembg.remove()` in thread pool via `asyncio.to_thread()` to avoid blocking event loop (rembg is CPU-bound)
- Convert result from RGBA PNG to RGB with #808080 gray background using Pillow
- Save to `tmp/manifests/{manifest_id}/clean_sheets/tier2_{asset.id}.png`
- Create AssetCleanReference record: tier="tier2_rembg", is_primary=True, generation_cost=0.0, face_similarity_score=None (no validation for Tier 2)
- Return path string

Handle ImportError for rembg gracefully: if rembg not installed, log warning and return None. This makes rembg an optional dependency.

**Function 2: `async generate_tier3_clean_sheet(session, asset, manifest_id, image_model="imagen-3.0-generate-002") -> Optional[str]`**

- Build conditioning prompt from asset.reverse_prompt with clean sheet directives (neutral gray #808080 background, studio lighting, no occlusion, preserve distinguishing features)
- Load reference image bytes
- Call `client.aio.models.generate_images()` with conditioning prompt and reference_images parameter
- If asset is CHARACTER and has face_embedding, validate face similarity:
  - Use `compute_face_similarity()` helper (inline in this module)
  - Threshold 0.6 for first 2 attempts, loosen to 0.5 on 3rd attempt
  - If all 3 attempts fail validation, return None (caller falls back to Tier 2 or original)
- Save clean sheet to `tmp/manifests/{manifest_id}/clean_sheets/tier3_{asset.id}.png`
- Create AssetCleanReference record: tier="tier3_gemini", is_primary=True, generation_cost=0.03 (estimated), face_similarity_score=computed_score
- Return path string or None on failure

**Function 3: `compute_face_similarity(original_bytes, clean_bytes, stored_embedding) -> float`**

- This is a synchronous helper (called via asyncio.to_thread)
- Uses insightface FaceAnalysis to extract embedding from clean sheet
- Computes cosine similarity against stored_embedding (numpy.frombuffer from Asset.face_embedding)
- Returns float 0.0-1.0
- Handle ImportError for insightface: if not installed, log warning and return 1.0 (skip validation)
- Handle no-face-detected: return 0.0

**Function 4: `async generate_clean_sheet(session, asset, manifest_id, tier="tier2") -> Optional[str]`**

Convenience dispatcher:
- tier="tier2" -> generate_tier2_clean_sheet
- tier="tier3" -> generate_tier3_clean_sheet
- Returns path or None

Add proper logging throughout. Use lazy model loading pattern for rembg and insightface (following cv_detection.py pattern from Phase 5).
  </action>
  <verify>
Run: `python -c "from vidpipe.services.clean_sheet_service import generate_clean_sheet, generate_tier2_clean_sheet, generate_tier3_clean_sheet, compute_face_similarity; print('All imports OK')"` -- confirms module loads.

Run: `grep -c 'AssetCleanReference' backend/vidpipe/services/clean_sheet_service.py` -- confirms database records created.

Run: `grep 'asyncio.to_thread' backend/vidpipe/services/clean_sheet_service.py` -- confirms CPU-bound work runs in thread pool.

Run: `grep 'is_primary.*True' backend/vidpipe/services/clean_sheet_service.py` -- confirms clean sheets marked as primary.
  </verify>
  <done>Clean sheet service exists with Tier 2 (rembg, $0 local) and Tier 3 (Gemini Image, ~$0.03) generation. Tier 3 validates face similarity for CHARACTER assets with max 3 retries and threshold loosening. All clean sheets stored in asset_clean_references table via AssetCleanReference records. rembg and insightface are optional dependencies with graceful ImportError handling.</done>
</task>

</tasks>

<verification>
- `python -c "from vidpipe.pipeline.video_gen import generate_videos; print('video_gen loads')"` -- module loads without error
- `python -c "from vidpipe.services.clean_sheet_service import generate_clean_sheet; print('clean_sheet loads')"` -- module loads without error
- `grep 'reference_type.*asset' backend/vidpipe/pipeline/video_gen.py` -- confirms "asset" reference type used
- `grep 'duration_seconds.*=.*8' backend/vidpipe/pipeline/video_gen.py` -- confirms 8-second enforcement
- `grep 'select_references_for_scene' backend/vidpipe/pipeline/video_gen.py` -- confirms selection logic called
- Non-manifest projects continue working (no reference_images passed, original duration used)
</verification>

<success_criteria>
1. video_gen.py loads scene manifest and selects up to 3 references per scene
2. References passed as referenceImages with referenceType="asset" to Veo 3.1
3. Duration forced to 8 seconds when references are attached
4. Selected reference tags persisted to SceneManifest.selected_reference_tags
5. Clean sheet Tier 2 removes background and saves to asset_clean_references
6. Clean sheet Tier 3 generates via Gemini Image with face similarity validation
7. Clean sheets never overwrite Asset.reference_image_url
8. Backward compatibility maintained for non-manifest projects
</success_criteria>

<output>
After completion, create `.planning/phases/08-veo-reference-passthrough-and-clean-sheets/08-02-SUMMARY.md`
</output>
