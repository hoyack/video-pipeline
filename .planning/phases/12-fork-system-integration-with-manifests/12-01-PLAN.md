---
phase: 12-fork-system-integration-with-manifests
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/migrate_phase12.sql
  - backend/vidpipe/db/models.py
  - backend/vidpipe/api/routes.py
autonomous: true

must_haves:
  truths:
    - "Asset model has is_inherited, inherited_from_asset, inherited_from_project columns"
    - "ProjectDetail response includes manifest_id for EditForkPanel to fetch assets"
    - "ForkRequest schema accepts asset_changes with modified_assets, removed_asset_ids, new_uploads"
    - "Fork endpoint returns 422 if asset_changes provided but source has no manifest"
  artifacts:
    - path: "backend/migrate_phase12.sql"
      provides: "SQL migration adding inheritance columns to assets table"
      contains: "ALTER TABLE assets ADD COLUMN is_inherited"
    - path: "backend/vidpipe/db/models.py"
      provides: "Asset model with inheritance fields"
      contains: "is_inherited"
    - path: "backend/vidpipe/api/routes.py"
      provides: "Extended ForkRequest, ProjectDetail with manifest_id, AssetChanges schema"
      contains: "AssetChanges"
  key_links:
    - from: "backend/migrate_phase12.sql"
      to: "backend/vidpipe/db/models.py"
      via: "Column names match between SQL migration and ORM mapped_columns"
      pattern: "is_inherited.*inherited_from_asset.*inherited_from_project"
    - from: "backend/vidpipe/api/routes.py"
      to: "backend/vidpipe/db/models.py"
      via: "ForkRequest.asset_changes references Asset inheritance fields"
      pattern: "class AssetChanges"
---

<objective>
Add Asset inheritance columns to the database, extend the ForkRequest Pydantic schema with asset_changes support, and add manifest_id to ProjectDetail response.

Purpose: Foundation layer for fork-based asset inheritance. All subsequent plans depend on these schema additions being in place.
Output: SQL migration file, updated ORM model, extended API schemas.
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-fork-system-integration-with-manifests/12-RESEARCH.md

@backend/vidpipe/db/models.py
@backend/vidpipe/api/routes.py
@backend/migrate_phase10.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: DB migration and Asset ORM inheritance fields</name>
  <files>backend/migrate_phase12.sql, backend/vidpipe/db/models.py</files>
  <action>
Create `backend/migrate_phase12.sql` with three ALTER TABLE statements adding columns to the `assets` table:
- `is_inherited BOOLEAN DEFAULT FALSE`
- `inherited_from_asset TEXT` (UUID stored as TEXT in SQLite)
- `inherited_from_project TEXT` (UUID stored as TEXT in SQLite)

Follow the exact pattern from `backend/migrate_phase10.sql` (simple ALTER TABLE ADD COLUMN statements).

Update `backend/vidpipe/db/models.py` Asset class — add three new fields AFTER the existing `source_asset_id` field (at the end of the Asset class body), with a "Phase 12: Fork inheritance tracking" comment:
- `is_inherited: Mapped[bool] = mapped_column(Boolean, default=False)`
- `inherited_from_asset: Mapped[Optional[uuid.UUID]] = mapped_column(ForeignKey("assets.id"), nullable=True)`
- `inherited_from_project: Mapped[Optional[uuid.UUID]] = mapped_column(ForeignKey("projects.id"), nullable=True)`

Use the same `Mapped[Optional[uuid.UUID]]` pattern already used by `source_asset_id` for the FK fields. Keep `is_inherited` defaulting to False so existing assets are unaffected.
  </action>
  <verify>
Run `python -c "from vidpipe.db.models import Asset; print(Asset.__table__.columns.keys())"` from `backend/` directory — output must include `is_inherited`, `inherited_from_asset`, `inherited_from_project`.
Confirm `backend/migrate_phase12.sql` exists with 3 ALTER TABLE statements.
  </verify>
  <done>Asset ORM model has three new inheritance columns; SQL migration file exists for applying to existing databases.</done>
</task>

<task type="auto">
  <name>Task 2: ForkRequest schema extension and ProjectDetail manifest_id</name>
  <files>backend/vidpipe/api/routes.py</files>
  <action>
In `backend/vidpipe/api/routes.py`, add three new Pydantic models BEFORE the existing `ForkRequest` class (around line 320):

```python
class ModifiedAsset(BaseModel):
    """Asset modification in a fork."""
    changes: dict  # {"reverse_prompt": "...", "name": "...", "reference_image": base64_str}

class NewUpload(BaseModel):
    """New reference image to add in fork."""
    image_data: str  # base64-encoded image
    name: str
    asset_type: str
    description: Optional[str] = None
    tags: Optional[list[str]] = None

class AssetChanges(BaseModel):
    """Asset changes for fork request."""
    modified_assets: dict[str, ModifiedAsset] = Field(default_factory=dict)  # asset_id -> changes
    removed_asset_ids: list[str] = Field(default_factory=list)
    new_uploads: list[NewUpload] = Field(default_factory=list)
```

Extend the existing `ForkRequest` class by adding ONE new field at the end:
- `asset_changes: Optional[AssetChanges] = None`

Extend the `ProjectDetail` class by adding `manifest_id: Optional[str] = None` after the `forked_from` field.

Update the `get_project_detail` endpoint's return statement (around line 750) to include:
- `manifest_id=str(project.manifest_id) if project.manifest_id else None`

Add early validation in `fork_project()` endpoint — AFTER the `overrides` dict is built (around line 1098, before `_compute_invalidation` call): if `request.asset_changes` is not None and `source.manifest_id` is None, raise `HTTPException(status_code=422, detail="Cannot apply asset_changes to a project without a manifest")`.
  </action>
  <verify>
Run `python -c "from vidpipe.api.routes import ForkRequest, AssetChanges, ModifiedAsset, NewUpload, ProjectDetail; print('OK')"` from `backend/` directory.
Verify ProjectDetail has manifest_id field: `python -c "from vidpipe.api.routes import ProjectDetail; print(ProjectDetail.model_fields.keys())"` — must include `manifest_id`.
  </verify>
  <done>ForkRequest accepts asset_changes (modified_assets, removed_asset_ids, new_uploads). ProjectDetail includes manifest_id. Fork endpoint returns 422 for asset_changes on non-manifest projects.</done>
</task>

</tasks>

<verification>
1. `python -c "from vidpipe.db.models import Asset; a = Asset.__table__; print([c.name for c in a.columns if 'inherit' in c.name])"` — prints `['is_inherited', 'inherited_from_asset', 'inherited_from_project']`
2. `python -c "from vidpipe.api.routes import ForkRequest; fr = ForkRequest.model_validate({'asset_changes': {'modified_assets': {}, 'removed_asset_ids': [], 'new_uploads': []}}); print(fr.asset_changes)"` — parses without error
3. `python -c "from vidpipe.api.routes import ProjectDetail; pd = ProjectDetail(project_id='x', prompt='x', style='x', aspect_ratio='x', status='x', created_at='x', updated_at='x', scene_count=0, scenes=[], manifest_id='abc'); print(pd.manifest_id)"` — prints `abc`
</verification>

<success_criteria>
- Asset model has 3 inheritance columns (is_inherited, inherited_from_asset, inherited_from_project)
- SQL migration file exists at backend/migrate_phase12.sql
- ForkRequest accepts optional asset_changes field
- AssetChanges, ModifiedAsset, NewUpload Pydantic models importable
- ProjectDetail includes manifest_id
- Fork endpoint validates asset_changes requires manifest
</success_criteria>

<output>
After completion, create `.planning/phases/12-fork-system-integration-with-manifests/12-01-SUMMARY.md`
</output>
