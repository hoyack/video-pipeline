---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - config.yaml
  - vidpipe/config.py
  - .env.example
autonomous: true

must_haves:
  truths:
    - "Configuration loads from config.yaml with YAML source priority"
    - "Environment variables override YAML values using VIDPIPE_ prefix"
    - "Settings model validates all required configuration sections"
    - "Database URL, tmp_dir, and pipeline parameters are configurable"
  artifacts:
    - path: "vidpipe/config.py"
      provides: "Pydantic settings with YAML and env var support"
      min_lines: 40
      contains: "YamlConfigSettingsSource"
    - path: "config.yaml"
      provides: "Default configuration values"
      contains: "database:"
    - path: ".env.example"
      provides: "Environment variable template"
  key_links:
    - from: "vidpipe/config.py"
      to: "pydantic_settings"
      via: "BaseSettings with custom sources"
      pattern: "from pydantic_settings import"
    - from: "vidpipe/config.py"
      to: "config.yaml"
      via: "YamlConfigSettingsSource loading"
      pattern: "yaml_file.*config\\.yaml"
---

<objective>
Implement type-safe configuration loading from YAML and environment variables using pydantic-settings.

Purpose: Establish configuration system that supports local development (YAML) and deployment (env vars) with validation.
Output: Working Settings class that loads from config.yaml with env var overrides.
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/ubuntu/work/video-pipeline/.planning/PROJECT.md
@/home/ubuntu/work/video-pipeline/.planning/ROADMAP.md
@/home/ubuntu/work/video-pipeline/.planning/STATE.md
@/home/ubuntu/work/video-pipeline/.planning/phases/01-foundation/01-RESEARCH.md
@/home/ubuntu/work/video-pipeline/docs/spec.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create config.yaml with default values</name>
  <files>config.yaml</files>
  <action>
Create config.yaml in project root with structure matching spec section 7:

```yaml
google_cloud:
  project_id: "hoyack-1577568661630"
  location: "us-central1"
  use_vertex_ai: true

models:
  storyboard_llm: "gemini-3-pro"
  image_gen: "gemini-3-pro-image-preview"
  video_gen: "veo-3.1-generate-001"

pipeline:
  default_style: "cinematic"
  default_aspect_ratio: "16:9"
  default_clip_duration: 4
  max_scenes: 15
  image_gen_delay: 3
  video_poll_interval: 15
  video_poll_max: 40
  video_gen_concurrency: 1
  crossfade_seconds: 0.0
  retry_max_attempts: 5
  retry_base_delay: 2

storage:
  database_url: "sqlite+aiosqlite:///vidpipe.db"
  tmp_dir: "./tmp"

server:
  host: "0.0.0.0"
  port: 8000
```

All values match spec defaults exactly.
  </action>
  <verify>
python -c "import yaml; config = yaml.safe_load(open('config.yaml')); assert 'google_cloud' in config; assert config['storage']['database_url'].startswith('sqlite'); print('YAML valid')"
  </verify>
  <done>
config.yaml exists with all sections from spec (google_cloud, models, pipeline, storage, server), YAML syntax is valid
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Settings class with YamlConfigSettingsSource</name>
  <files>
vidpipe/config.py
.env.example
  </files>
  <action>
Create vidpipe/config.py following research Pattern 4:

1. Define nested config models using BaseModel (NOT BaseSettings):
   - GoogleCloudConfig(BaseModel): project_id, location, use_vertex_ai
   - ModelsConfig(BaseModel): storyboard_llm, image_gen, video_gen
   - PipelineConfig(BaseModel): all pipeline fields from config.yaml
   - StorageConfig(BaseModel): database_url, tmp_dir (as Path with validator)
   - ServerConfig(BaseModel): host, port

2. Create main Settings(BaseSettings) class:
   - Fields: google_cloud, models, pipeline, storage, server (all nested models)
   - model_config = SettingsConfigDict(yaml_file="config.yaml", env_nested_delimiter="__", env_prefix="VIDPIPE_")
   - Implement settings_customise_sources classmethod returning (env_settings, YamlConfigSettingsSource(settings_cls), init_settings)

3. Add field_validator for StorageConfig.tmp_dir to convert str to Path

4. Create singleton: settings = Settings() at module level

5. Create .env.example with commented examples:
   ```
   # Google Cloud (optional - defaults from config.yaml)
   # VIDPIPE_GOOGLE_CLOUD__PROJECT_ID=your-project-id
   # VIDPIPE_GOOGLE_CLOUD__LOCATION=us-central1

   # Storage (optional overrides)
   # VIDPIPE_STORAGE__DATABASE_URL=sqlite+aiosqlite:///vidpipe.db
   # VIDPIPE_STORAGE__TMP_DIR=/custom/tmp/path

   # Pipeline (optional overrides)
   # VIDPIPE_PIPELINE__MAX_SCENES=10
   # VIDPIPE_PIPELINE__RETRY_MAX_ATTEMPTS=3
   ```

Use research Pattern 4 exactly - env vars override YAML which overrides defaults. Import YamlConfigSettingsSource from pydantic_settings.

CRITICAL per research Pitfall 7: Nested models must inherit from BaseModel, NOT BaseSettings.
  </action>
  <verify>
python -c "from vidpipe.config import settings; assert settings.google_cloud.project_id == 'hoyack-1577568661630'; assert settings.pipeline.max_scenes == 15; print(f'Config loaded: db={settings.storage.database_url}')"
VIDPIPE_PIPELINE__MAX_SCENES=20 python -c "from vidpipe.config import settings; assert settings.pipeline.max_scenes == 20; print('Env override works')"
  </verify>
  <done>
vidpipe/config.py exists with Settings class using YamlConfigSettingsSource, settings singleton can be imported, env vars override YAML values, .env.example created
  </done>
</task>

</tasks>

<verification>
1. Load settings without env vars: python -c "from vidpipe.config import settings; print(settings.model_dump())"
2. Override with env var: VIDPIPE_STORAGE__TMP_DIR=/tmp/test python -c "from vidpipe.config import settings; assert str(settings.storage.tmp_dir) == '/tmp/test'"
3. Verify YAML parsing: python -c "import yaml; yaml.safe_load(open('config.yaml'))"
</verification>

<success_criteria>
- config.yaml exists with all sections matching spec section 7
- vidpipe/config.py implements Settings(BaseSettings) with YamlConfigSettingsSource
- Settings can be imported and instantiated without errors
- Environment variables with VIDPIPE_ prefix override YAML values
- Nested delimiter __ works (e.g., VIDPIPE_PIPELINE__MAX_SCENES)
- settings.storage.tmp_dir is a Path object
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
