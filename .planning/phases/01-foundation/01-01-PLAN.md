---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - vidpipe/__init__.py
  - vidpipe/db/__init__.py
  - vidpipe/db/models.py
  - requirements.txt
autonomous: true

must_haves:
  truths:
    - "Project has valid Python package structure with vidpipe/ module"
    - "Database models exist with all 5 entities from spec (Project, Scene, Keyframe, VideoClip, PipelineRun)"
    - "Models use SQLAlchemy 2.0 Mapped annotations with proper types"
    - "Models define foreign key relationships between entities"
  artifacts:
    - path: "pyproject.toml"
      provides: "Project metadata and dependencies"
      contains: "sqlalchemy"
    - path: "vidpipe/db/models.py"
      provides: "ORM models for all pipeline entities"
      min_lines: 100
      contains: "class Project"
    - path: "vidpipe/__init__.py"
      provides: "Package initialization"
  key_links:
    - from: "vidpipe/db/models.py"
      to: "sqlalchemy.orm"
      via: "import DeclarativeBase, Mapped"
      pattern: "from sqlalchemy.orm import"
    - from: "vidpipe/db/models.py"
      to: "Scene.project_id"
      via: "foreign key relationship"
      pattern: "ForeignKey.*projects"
---

<objective>
Establish Python project structure and define SQLAlchemy ORM models for all pipeline entities.

Purpose: Create the foundational package structure and type-safe database schema that all subsequent work depends on.
Output: Installable Python package with complete data model matching spec section 4.
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/ubuntu/work/video-pipeline/.planning/PROJECT.md
@/home/ubuntu/work/video-pipeline/.planning/ROADMAP.md
@/home/ubuntu/work/video-pipeline/.planning/STATE.md
@/home/ubuntu/work/video-pipeline/.planning/phases/01-foundation/01-RESEARCH.md
@/home/ubuntu/work/video-pipeline/docs/spec.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create project structure and pyproject.toml</name>
  <files>
pyproject.toml
requirements.txt
vidpipe/__init__.py
vidpipe/db/__init__.py
vidpipe/services/__init__.py
vidpipe/pipeline/__init__.py
vidpipe/schemas/__init__.py
  </files>
  <action>
Create Python package structure matching spec section 8:

1. Create pyproject.toml with:
   - name = "vidpipe"
   - version = "0.1.0"
   - requires-python = ">=3.11"
   - dependencies: sqlalchemy[asyncio]>=2.0, aiosqlite>=0.22.1, pydantic>=2.0, pydantic-settings>=2.12.0, fastapi>=0.115.0, uvicorn>=0.30.0, typer>=0.12.0, rich>=13.0, Pillow>=10.0, httpx>=0.27.0, python-dotenv>=1.0, pyyaml>=6.0, google-genai>=1.0.0

2. Create requirements.txt with same dependencies (for pip install -e .)

3. Create directory structure:
   - vidpipe/__init__.py (empty for now)
   - vidpipe/db/__init__.py (empty for now)
   - vidpipe/services/__init__.py (empty)
   - vidpipe/pipeline/__init__.py (empty)
   - vidpipe/schemas/__init__.py (empty)

4. Create tmp/.gitkeep to ensure artifacts directory exists

Use pyproject.toml format per PEP 621 with [project] table and [build-system] using setuptools.
  </action>
  <verify>
python -c "import tomllib; tomllib.loads(open('pyproject.toml', 'rb').read())" to validate TOML syntax
ls vidpipe/db/__init__.py vidpipe/services/__init__.py to confirm structure
  </verify>
  <done>
pyproject.toml exists with all required dependencies, vidpipe/ package structure created with db/, services/, pipeline/, and schemas/ subdirectories
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement SQLAlchemy 2.0 models with Mapped annotations</name>
  <files>vidpipe/db/models.py</files>
  <action>
Create vidpipe/db/models.py with all 5 models from spec section 4 using SQLAlchemy 2.0 declarative style:

1. Create Base class:
   - from sqlalchemy.orm import DeclarativeBase
   - class Base(DeclarativeBase): pass

2. Implement Project model (spec 4.1):
   - id: Mapped[uuid.UUID] with primary_key=True, default=uuid.uuid4
   - prompt: Mapped[str] with Text column type
   - style: Mapped[str] with String(50)
   - aspect_ratio: Mapped[str] with String(10)
   - target_clip_duration: Mapped[int]
   - status: Mapped[str] with String(50)
   - style_guide: Mapped[dict | None] with JSON column type, nullable=True
   - storyboard_raw: Mapped[dict | None] with JSON, nullable=True
   - output_path: Mapped[str | None] with String(255), nullable=True
   - error_message: Mapped[str | None] with Text, nullable=True
   - created_at: Mapped[datetime] with server_default=func.now()
   - updated_at: Mapped[datetime] with server_default=func.now(), onupdate=func.now()

3. Implement Scene model (spec 4.2):
   - id: Mapped[uuid.UUID] primary key
   - project_id: Mapped[uuid.UUID] with ForeignKey("projects.id")
   - scene_index: Mapped[int]
   - scene_description: Mapped[str] with Text
   - start_frame_prompt: Mapped[str] with Text
   - end_frame_prompt: Mapped[str] with Text
   - video_motion_prompt: Mapped[str] with Text
   - transition_notes: Mapped[str | None] with Text, nullable=True
   - status: Mapped[str] with String(50)

4. Implement Keyframe model (spec 4.3):
   - id: Mapped[uuid.UUID] primary key
   - scene_id: Mapped[uuid.UUID] with ForeignKey("scenes.id")
   - position: Mapped[str] with String(10) for "start" or "end"
   - prompt_used: Mapped[str] with Text
   - file_path: Mapped[str] with String(255)
   - mime_type: Mapped[str] with String(20)
   - source: Mapped[str] with String(20) for "generated" or "inherited"
   - created_at: Mapped[datetime] with server_default=func.now()

5. Implement VideoClip model (spec 4.4):
   - id: Mapped[uuid.UUID] primary key
   - scene_id: Mapped[uuid.UUID] with ForeignKey("scenes.id")
   - operation_name: Mapped[str | None] with String(255), nullable=True
   - status: Mapped[str] with String(50)
   - gcs_uri: Mapped[str | None] with String(500), nullable=True
   - local_path: Mapped[str | None] with String(255), nullable=True
   - duration_seconds: Mapped[float | None], nullable=True
   - poll_count: Mapped[int] with default=0
   - error_message: Mapped[str | None] with Text, nullable=True
   - created_at: Mapped[datetime] with server_default=func.now()
   - completed_at: Mapped[datetime | None], nullable=True

6. Implement PipelineRun model (spec 4.5):
   - id: Mapped[uuid.UUID] primary key
   - project_id: Mapped[uuid.UUID] with ForeignKey("projects.id")
   - started_at: Mapped[datetime] with server_default=func.now()
   - completed_at: Mapped[datetime | None], nullable=True
   - total_duration_seconds: Mapped[float | None], nullable=True
   - total_api_cost_estimate: Mapped[float | None], nullable=True
   - log: Mapped[dict | None] with JSON, nullable=True

Use imports: uuid, datetime from datetime, func from sqlalchemy, String/Text/JSON from sqlalchemy, DeclarativeBase/Mapped/mapped_column from sqlalchemy.orm

Follow research Pattern 2 exactly - use Mapped[Type] annotations, not Column() definitions.
  </action>
  <verify>
python -c "from vidpipe.db.models import Base, Project, Scene, Keyframe, VideoClip, PipelineRun; print(f'Models loaded: {len(Base.metadata.tables)} tables')"
python -c "from vidpipe.db.models import Project; assert hasattr(Project, 'id'); assert hasattr(Project, 'prompt'); print('Project model validated')"
  </verify>
  <done>
vidpipe/db/models.py exists with Base class and all 5 models (Project, Scene, Keyframe, VideoClip, PipelineRun) using Mapped annotations, models can be imported without errors
  </done>
</task>

</tasks>

<verification>
1. Run: python -c "import vidpipe; import vidpipe.db; from vidpipe.db.models import Base, Project; print('Package imports successful')"
2. Verify all 5 models defined with correct table names and column counts
3. Check foreign key relationships exist (Scene.project_id, Keyframe.scene_id, VideoClip.scene_id, PipelineRun.project_id)
</verification>

<success_criteria>
- pyproject.toml exists with all dependencies from spec section 9
- vidpipe/ package structure matches spec section 8
- vidpipe/db/models.py contains 5 complete ORM models using SQLAlchemy 2.0 Mapped syntax
- All models can be imported without errors
- Models match spec section 4 schema exactly (columns, types, relationships)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
