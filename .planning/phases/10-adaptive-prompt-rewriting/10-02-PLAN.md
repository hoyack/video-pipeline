---
phase: 10-adaptive-prompt-rewriting
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - backend/vidpipe/pipeline/keyframes.py
  - backend/vidpipe/pipeline/video_gen.py
autonomous: true

must_haves:
  truths:
    - "Manifest projects use rewritten keyframe prompt for start frame generation instead of static storyboard prompt"
    - "Manifest projects use rewritten video prompt as base for Veo submission instead of static storyboard prompt"
    - "Non-manifest projects continue using original storyboard prompts unchanged (backward compatible)"
    - "LLM-selected reference tags override Phase 8 deterministic selection for building veo_ref_images"
    - "Rewritten prompts are persisted to scene_manifests.rewritten_keyframe_prompt and rewritten_video_prompt"
    - "Safety prefixes stack on top of rewritten video prompt (rewritten = base, safety = prefix)"
    - "Rewriter failure gracefully falls back to original storyboard prompt with warning log"
    - "Continuity data from scene N-1 cv_analysis_json feeds into scene N rewriter call"
  artifacts:
    - path: "backend/vidpipe/pipeline/keyframes.py"
      provides: "Keyframe generation with adaptive prompt rewriting hook for manifest projects"
      contains: "PromptRewriterService"
    - path: "backend/vidpipe/pipeline/video_gen.py"
      provides: "Video generation with adaptive prompt rewriting hook and LLM reference override"
      contains: "PromptRewriterService"
  key_links:
    - from: "backend/vidpipe/pipeline/keyframes.py"
      to: "backend/vidpipe/services/prompt_rewriter.py"
      via: "import and call rewrite_keyframe_prompt before Imagen generation"
      pattern: "rewriter\\.rewrite_keyframe_prompt"
    - from: "backend/vidpipe/pipeline/video_gen.py"
      to: "backend/vidpipe/services/prompt_rewriter.py"
      via: "import and call rewrite_video_prompt before Veo submission"
      pattern: "rewriter\\.rewrite_video_prompt"
    - from: "backend/vidpipe/pipeline/video_gen.py"
      to: "backend/vidpipe/db/models.SceneManifest"
      via: "persist rewritten_video_prompt and override selected_reference_tags"
      pattern: "scene_manifest_row\\.rewritten_video_prompt"
    - from: "backend/vidpipe/pipeline/video_gen.py"
      to: "backend/vidpipe/services/reference_selection.py"
      via: "LLM tags override Phase 8 selection for veo_ref_images rebuild"
      pattern: "selected_reference_tags"
---

<objective>
Integrate PromptRewriterService into keyframes.py and video_gen.py pipeline hooks, replacing static storyboard prompts with dynamically enriched versions for manifest projects.

Purpose: Wire the rewriter into the two generation pipeline entry points so that every manifest-project scene gets a cinematography-formula prompt with asset injection, continuity corrections, audio direction (video only), and LLM-reasoned reference selection. Non-manifest projects are unaffected.

Output: Modified keyframes.py with rewriter hook before Imagen calls. Modified video_gen.py with rewriter hook before Veo submission, safety prefix coordination, and LLM reference selection override.
</objective>

<execution_context>
@/home/ubuntu/.claude/get-shit-done/workflows/execute-plan.md
@/home/ubuntu/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-adaptive-prompt-rewriting/10-RESEARCH.md
@.planning/phases/10-adaptive-prompt-rewriting/10-01-SUMMARY.md
@backend/vidpipe/pipeline/keyframes.py
@backend/vidpipe/pipeline/video_gen.py
@backend/vidpipe/db/models.py
@backend/vidpipe/services/prompt_rewriter.py
@backend/vidpipe/services/reference_selection.py
@backend/vidpipe/services/manifest_service.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate rewriter into keyframes.py</name>
  <files>backend/vidpipe/pipeline/keyframes.py</files>
  <action>
Modify `generate_keyframes()` in `keyframes.py` to call the prompt rewriter before start frame generation for manifest projects.

**Where to hook:** Inside the `for scene in scenes:` loop, AFTER the skip check for existing keyframes and BEFORE the "Generate or inherit START frame" section. The rewriter only applies to start frame generation (scene 0 text-to-image, or any scene where start_frame_prompt would be used).

**Implementation steps:**

1. Add imports at the top of the file (lazy, inside the manifest guard to avoid circular imports):
   - `from vidpipe.db.models import SceneManifest as SceneManifestModel` (add to existing imports section)
   - The PromptRewriterService import goes inside the `if project.manifest_id:` guard (lazy import pattern)

2. After the existing keyframe skip check and before the "Generate or inherit START frame" section, add the rewriter block:

```python
# Phase 10: Adaptive Prompt Rewriting for manifest projects
rewritten_start_prompt = None
if project.manifest_id:
    try:
        from vidpipe.services.prompt_rewriter import PromptRewriterService
        from vidpipe.db.models import SceneManifest as SceneManifestModel

        # Load scene manifest
        sm_result = await session.execute(
            select(SceneManifestModel).where(
                SceneManifestModel.project_id == project.id,
                SceneManifestModel.scene_index == scene.scene_index
            )
        )
        scene_manifest_row = sm_result.scalar_one_or_none()

        if scene_manifest_row and scene_manifest_row.manifest_json:
            # Load assets
            from vidpipe.services import manifest_service
            all_assets = await manifest_service.load_manifest_assets(session, project.manifest_id)

            # Load previous scene CV analysis for continuity
            previous_cv = None
            if scene.scene_index > 0:
                prev_sm_result = await session.execute(
                    select(SceneManifestModel).where(
                        SceneManifestModel.project_id == project.id,
                        SceneManifestModel.scene_index == scene.scene_index - 1
                    )
                )
                prev_sm = prev_sm_result.scalar_one_or_none()
                if prev_sm:
                    previous_cv = prev_sm.cv_analysis_json

            rewriter = PromptRewriterService()
            result = await rewriter.rewrite_keyframe_prompt(
                scene=scene,
                scene_manifest_json=scene_manifest_row.manifest_json,
                placed_assets=all_assets,  # rewriter filters to placed internally
                previous_cv_analysis=previous_cv,
                all_assets=all_assets,
            )

            rewritten_start_prompt = result.rewritten_prompt

            # Persist rewritten prompt
            scene_manifest_row.rewritten_keyframe_prompt = result.rewritten_prompt
            await session.commit()

            logger.info(
                f"Scene {scene.scene_index}: keyframe prompt rewritten "
                f"(refs: {result.selected_reference_tags})"
            )
    except Exception as e:
        logger.warning(
            f"Scene {scene.scene_index}: keyframe rewriter failed (non-fatal): {e}"
        )
        rewritten_start_prompt = None  # Fall back to original
```

3. Modify the Scene 0 start frame generation to use the rewritten prompt when available:

In the `if scene.scene_index == 0:` block, change:
```python
# BEFORE:
enriched_prompt = f"{style_prefix}{character_prefix}{scene.start_frame_prompt}"

# AFTER:
if rewritten_start_prompt:
    # Phase 10: Use rewritten prompt (already includes asset details + composition)
    enriched_prompt = f"{style_prefix}{rewritten_start_prompt}"
else:
    enriched_prompt = f"{style_prefix}{character_prefix}{scene.start_frame_prompt}"
```

Note: When using the rewritten prompt, we still prepend `style_prefix` for model-level style consistency, but omit `character_prefix` because the rewriter already injected asset reverse_prompts with full character descriptions. This avoids double-injecting character details.

**IMPORTANT:** The rewriter only affects the START frame prompt. End frames use image-conditioned generation from the start frame image, so they continue using `scene.end_frame_prompt` as the conditioning prompt unchanged. This matches the research recommendation (open question 1).

**IMPORTANT:** Scene N (N>0) start frames are INHERITED from previous scene's end frame, so the rewritten prompt does NOT apply to inherited start frames. The `rewritten_start_prompt` variable is only used in the `if scene.scene_index == 0:` branch. However, if the rewriter runs, it still stores the rewritten prompt in the database for debugging/display even for non-scene-0 scenes.
  </action>
  <verify>
Run `python -c "from vidpipe.pipeline.keyframes import generate_keyframes; print('Import OK')"` from backend/ directory — verifies no import errors.
Read keyframes.py and verify:
1. `PromptRewriterService` is imported inside the manifest guard (not at module level)
2. `rewritten_start_prompt` is initialized to None before the manifest guard
3. Rewriter failure is wrapped in try/except with warning log
4. Scene 0 uses rewritten prompt when available, falls back to original
5. `scene_manifest_row.rewritten_keyframe_prompt` is persisted
  </verify>
  <done>
Keyframe pipeline calls PromptRewriterService for manifest projects before start frame generation. Scene 0 uses rewritten prompt with style prefix. Scenes N>0 still inherit start frames. Rewriter failure gracefully falls back to original storyboard prompt. Rewritten prompt persisted to scene_manifests.rewritten_keyframe_prompt.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate rewriter into video_gen.py with safety prefix coordination and LLM reference override</name>
  <files>backend/vidpipe/pipeline/video_gen.py</files>
  <action>
Modify `_generate_video_for_scene()` in `video_gen.py` to call the prompt rewriter before Veo submission and use LLM-selected references to override Phase 8's deterministic selection.

**Where to hook:** AFTER the existing Phase 8 scene manifest + reference selection block (lines ~527-561 in current code), BEFORE the "Check if VideoClip already exists" section. The rewriter runs once, produces a base prompt and reference tags, then the escalation loop uses that base prompt with safety prefixes stacked on top.

**Implementation steps:**

1. After the existing Phase 8 reference selection block (after `selected_refs` is populated) and before the VideoClip resume check, add the rewriter block:

```python
# Phase 10: Adaptive Prompt Rewriting for manifest projects
base_video_prompt = None  # Will hold rewritten or original prompt
if project.manifest_id and scene_manifest_row and scene_manifest_row.manifest_json:
    try:
        from vidpipe.services.prompt_rewriter import PromptRewriterService
        from vidpipe.db.models import SceneAudioManifest as SceneAudioManifestModel

        # Load audio manifest
        audio_result = await session.execute(
            select(SceneAudioManifestModel).where(
                SceneAudioManifestModel.project_id == project.id,
                SceneAudioManifestModel.scene_index == scene.scene_index
            )
        )
        audio_manifest_row = audio_result.scalar_one_or_none()
        audio_manifest_json = None
        if audio_manifest_row:
            audio_manifest_json = {
                "dialogue_lines": audio_manifest_row.dialogue_json,
                "sfx": audio_manifest_row.sfx_json,
                "ambient": audio_manifest_row.ambient_json,
                "music": audio_manifest_row.music_json,
            }

        # Load previous scene CV analysis for continuity
        previous_cv = None
        if scene.scene_index > 0:
            prev_sm_result = await session.execute(
                select(SceneManifestModel).where(
                    SceneManifestModel.project_id == project.id,
                    SceneManifestModel.scene_index == scene.scene_index - 1
                )
            )
            prev_sm = prev_sm_result.scalar_one_or_none()
            if prev_sm:
                previous_cv = prev_sm.cv_analysis_json

        # all_assets already loaded above in Phase 8 block
        rewriter = PromptRewriterService()
        result = await rewriter.rewrite_video_prompt(
            scene=scene,
            scene_manifest_json=scene_manifest_row.manifest_json,
            audio_manifest_json=audio_manifest_json,
            placed_assets=all_assets,
            previous_cv_analysis=previous_cv,
            all_assets=all_assets,
        )

        base_video_prompt = result.rewritten_prompt

        # Persist rewritten video prompt
        scene_manifest_row.rewritten_video_prompt = result.rewritten_prompt

        # LLM reference selection overrides Phase 8's deterministic selection
        if result.selected_reference_tags:
            asset_map = {a.manifest_tag: a for a in all_assets}
            llm_selected = [
                asset_map[tag]
                for tag in result.selected_reference_tags
                if tag in asset_map
            ]
            if llm_selected:
                selected_refs = llm_selected
                scene_manifest_row.selected_reference_tags = result.selected_reference_tags
                logger.info(
                    f"Scene {scene.scene_index}: LLM override refs: "
                    f"{result.selected_reference_tags} "
                    f"(reason: {result.reference_reasoning})"
                )

        await session.commit()

        logger.info(
            f"Scene {scene.scene_index}: video prompt rewritten "
            f"({len(result.rewritten_prompt)} chars)"
        )
    except Exception as e:
        logger.warning(
            f"Scene {scene.scene_index}: video rewriter failed (non-fatal): {e}"
        )
        base_video_prompt = None  # Fall back to original
```

2. **CRITICAL: Rebuild veo_ref_images after LLM override.** The existing code builds `veo_ref_images` from `selected_refs` BEFORE the rewriter runs. After the rewriter potentially changes `selected_refs`, we need to rebuild `veo_ref_images`. Move the entire `veo_ref_images` construction block (lines ~588-610 in current code) to AFTER the rewriter block. Or, more cleanly, keep the existing block where it is but add a rebuild after the rewriter:

```python
# Rebuild veo_ref_images if LLM changed selected_refs
if base_video_prompt and selected_refs:
    veo_ref_images = []
    for asset in selected_refs:
        clean_ref = await get_primary_clean_reference(session, asset.id)
        img_url = clean_ref.clean_image_url if clean_ref else asset.reference_image_url
        if img_url:
            ref_bytes = Path(img_url).read_bytes()
            veo_ref_images.append(
                types.VideoGenerationReferenceImage(
                    reference_image=types.Image(
                        image_bytes=ref_bytes,
                        mime_type="image/png"
                    ),
                    reference_type=types.VideoGenerationReferenceType.ASSET
                )
            )
    if not veo_ref_images:
        veo_ref_images = None
```

3. **CRITICAL: Safety prefix coordination in the escalation loop.** Modify the video prompt construction inside the `for safety_level in range(max_levels):` loop. Currently it reads:
```python
video_prompt = (
    f"{_VIDEO_SAFETY_PREFIXES[safety_level]}"
    f"{scene.video_motion_prompt}. "
    f"Maintain the visual style shown in the source frames."
)
```

Change to:
```python
# Use rewritten prompt as base if available, otherwise original
if base_video_prompt:
    video_prompt = (
        f"{_VIDEO_SAFETY_PREFIXES[safety_level]}"
        f"{base_video_prompt}"
    )
else:
    video_prompt = (
        f"{_VIDEO_SAFETY_PREFIXES[safety_level]}"
        f"{scene.video_motion_prompt}. "
        f"Maintain the visual style shown in the source frames."
    )
```

This ensures:
- Rewritten prompt is the BASE (already contains full cinematography formula + audio direction)
- Safety prefixes STACK ON TOP of the base (level 0 = empty prefix, level 1+ = safety language)
- Rewritten prompt does NOT get the "Maintain the visual style" suffix (the rewriter already handles style via manifest metadata)
- Non-manifest projects and rewriter failures use the original path unchanged

**IMPORTANT implementation notes:**
- The `all_assets` variable is already loaded in the Phase 8 block above — reuse it, do NOT reload
- The `SceneManifestModel` import already exists at the top of `_generate_video_for_scene`
- The rewriter try/except must NOT catch the PipelineStopped exception — use `except Exception as e:` which is fine since PipelineStopped inherits from a custom base, not Exception (verify this; if it inherits from Exception, add `if isinstance(e, PipelineStopped): raise` inside the except block)
- Keep the Phase 9 `_run_post_generation_analysis` call unchanged — it runs AFTER video generation completes
  </action>
  <verify>
Run `python -c "from vidpipe.pipeline.video_gen import generate_videos; print('Import OK')"` from backend/ directory.
Read video_gen.py and verify:
1. Rewriter block appears AFTER Phase 8 reference selection, BEFORE VideoClip resume check
2. `base_video_prompt` initialized to None, set from rewriter result
3. LLM `selected_reference_tags` overrides `selected_refs` and persists to scene_manifest_row
4. `veo_ref_images` is rebuilt from potentially-overridden `selected_refs`
5. Escalation loop uses `base_video_prompt` as base with safety prefix stacked
6. Non-manifest path unchanged: `scene.video_motion_prompt` with style suffix
7. Rewriter failure wrapped in try/except with warning log, falls back to None
8. `scene_manifest_row.rewritten_video_prompt` is persisted
  </verify>
  <done>
Video pipeline calls PromptRewriterService for manifest projects. Rewritten prompt serves as base with safety prefixes stacking on top during escalation. LLM-selected references override Phase 8 deterministic selection and veo_ref_images is rebuilt accordingly. Audio direction from SceneAudioManifest embedded in rewritten video prompt. Continuity patches from previous scene CV analysis injected. Non-manifest projects and rewriter failures use original storyboard prompts unchanged.
  </done>
</task>

</tasks>

<verification>
1. Imports: `python -c "from vidpipe.pipeline.keyframes import generate_keyframes; from vidpipe.pipeline.video_gen import generate_videos; print('All pipeline imports OK')"`
2. No circular imports: `python -c "import vidpipe.services.prompt_rewriter; import vidpipe.pipeline.keyframes; import vidpipe.pipeline.video_gen; import vidpipe.services.manifest_service; print('No circular imports')"`
3. Grep for key patterns in keyframes.py: `PromptRewriterService`, `rewritten_start_prompt`, `rewritten_keyframe_prompt`, `rewriter failed (non-fatal)`
4. Grep for key patterns in video_gen.py: `PromptRewriterService`, `base_video_prompt`, `rewritten_video_prompt`, `LLM override refs`, `rewriter failed (non-fatal)`
5. Verify safety prefix coordination: the escalation loop uses `base_video_prompt` (not `scene.video_motion_prompt`) when rewriter succeeded
6. Verify backward compatibility: non-manifest path (no project.manifest_id) reaches original prompt construction unchanged
</verification>

<success_criteria>
- Manifest projects: keyframe start frames use rewritten prompts from PromptRewriterService
- Manifest projects: video prompts use rewritten prompts with safety prefixes stacked on top
- Non-manifest projects: both pipelines use original storyboard prompts (zero behavioral change)
- LLM reference selection overrides Phase 8 deterministic selection for manifest projects
- veo_ref_images rebuilt after LLM override to match new selected_refs
- Rewriter failures gracefully fall back to original prompts with warning logs
- Rewritten prompts persisted to scene_manifests table (rewritten_keyframe_prompt, rewritten_video_prompt)
- Continuity from scene N-1 cv_analysis_json injected into scene N rewriter context
- Audio direction from SceneAudioManifest injected into video rewriter context
- Safety prefix escalation loop correctly uses rewritten prompt as base
</success_criteria>

<output>
After completion, create `.planning/phases/10-adaptive-prompt-rewriting/10-02-SUMMARY.md`
</output>
