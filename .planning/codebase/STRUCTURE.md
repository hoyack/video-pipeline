# Codebase Structure

**Analysis Date:** 2026-02-16

## Directory Layout

```
video-pipeline/
├── backend/                    # FastAPI + SQLAlchemy backend
│   └── vidpipe/
│       ├── __init__.py         # Package initialization, dependency validation
│       ├── __main__.py         # CLI entry point
│       ├── api/                # HTTP endpoint handlers
│       │   ├── app.py          # FastAPI app setup, lifespan, CORS, exception handlers
│       │   ├── routes.py       # Endpoint implementations, Pydantic schemas
│       │   └── __main__.py     # "python -m vidpipe.api" entry point
│       ├── cli/                # Command-line interface (not used in main flow)
│       │   ├── __main__.py
│       │   └── commands.py
│       ├── db/                 # Database layer
│       │   ├── __init__.py     # async_session factory export
│       │   ├── engine.py       # SQLAlchemy async engine, PRAGMA config
│       │   └── models.py       # ORM models (Project, Scene, Keyframe, VideoClip, PipelineRun)
│       ├── orchestrator/       # Pipeline orchestration
│       │   ├── pipeline.py     # Main orchestrator loop, step execution
│       │   └── state.py        # State machine constants, resume logic
│       ├── pipeline/           # Pipeline step implementations
│       │   ├── storyboard.py   # Gemini LLM storyboard generation
│       │   ├── keyframes.py    # Imagen/Gemini keyframe generation
│       │   ├── video_gen.py    # Veo video clip generation
│       │   └── stitcher.py     # ffmpeg video concatenation
│       ├── schemas/            # Pydantic data schemas
│       │   ├── __init__.py
│       │   └── storyboard.py   # SceneSchema, StoryboardOutput (Gemini structured output)
│       ├── services/           # Cross-cutting utilities
│       │   ├── __init__.py
│       │   ├── file_manager.py # Filesystem I/O with path traversal protection
│       │   └── vertex_client.py # GCP Vertex AI client factory
│       └── config.py           # Pydantic Settings with YAML + env support
├── frontend/                   # React + TypeScript SPA
│   ├── src/
│   │   ├── api/                # API client and types
│   │   │   ├── client.ts       # Fetch-based API wrapper functions
│   │   │   └── types.ts        # Pydantic-compatible request/response types
│   │   ├── components/         # React components
│   │   │   ├── App.tsx         # Root component with view routing
│   │   │   ├── Layout.tsx      # Top-level layout with nav
│   │   │   ├── GenerateForm.tsx # Form for creating new project
│   │   │   ├── ProgressView.tsx # Real-time progress polling
│   │   │   ├── ProjectList.tsx  # List all projects
│   │   │   ├── ProjectDetail.tsx # Full project view with scenes, fork/stop
│   │   │   ├── Dashboard.tsx    # Aggregate metrics view
│   │   │   ├── SceneCard.tsx    # Scene detail card
│   │   │   ├── EditableSceneCard.tsx # Editable scene for fork UI
│       │   ├── EditForkPanel.tsx # Fork parameter editor
│   │   │   ├── PipelineStepper.tsx # Visual progress stepper
│   │   │   ├── StatusBadge.tsx  # Status indicator component
│   │   ├── hooks/              # Custom React hooks
│   │   │   ├── useProjectStatus.ts # Status polling with backoff
│   │   │   └── usePolling.ts    # Generic polling hook
│   │   ├── lib/
│   │   │   └── constants.ts    # Model IDs, allowed values
│   │   ├── assets/             # Images, icons (if any)
│   │   ├── main.tsx            # React app bootstrap
│   │   └── App.tsx             # Already listed above
│   ├── public/                 # Static assets
│   ├── dist/                   # Build output (generated by `npm run build`)
│   ├── package.json            # npm dependencies (React, Tailwind, TypeScript, Vite)
│   ├── tsconfig.json           # TypeScript configuration
│   ├── tailwind.config.js      # Tailwind CSS configuration
│   └── vite.config.ts          # Vite bundler configuration
├── .planning/                  # GSD planning artifacts
│   ├── codebase/               # This directory (ARCHITECTURE.md, STRUCTURE.md, etc.)
│   └── phases/                 # Implementation phases
├── config.yaml                 # Pipeline configuration (models, delays, storage paths)
├── backend/
│   ├── pyproject.toml          # Python dependencies (SQLAlchemy, FastAPI, tenacity)
│   ├── requirements.txt         # Pinned dependency versions
│   └── vidpipe.egg-info/       # Package metadata (auto-generated)
├── vidpipe.db                  # SQLite database (created at runtime)
├── vidpipe.db-shm              # SQLite WAL shared memory (created at runtime)
├── vidpipe.db-wal              # SQLite WAL write-ahead log (created at runtime)
├── tmp/                        # Temporary storage for artifacts (project_id/keyframes, clips, output)
├── docs/                       # Documentation (if any)
├── .env                        # Environment variables (not committed; use .env.example)
├── .env.example                # Template for .env
├── .gitignore                  # Git ignore rules
├── LICENSE                     # Project license
└── README.md                   # Project documentation
```

## Directory Purposes

**backend/vidpipe/api/:**
- Purpose: HTTP layer
- Contains: FastAPI application, route handlers, request/response validation
- Key files: `app.py` (app initialization), `routes.py` (endpoints)

**backend/vidpipe/db/:**
- Purpose: Data persistence layer
- Contains: SQLAlchemy ORM models, async session factory, database configuration
- Key files: `models.py` (Project, Scene, Keyframe, VideoClip, PipelineRun), `engine.py` (async engine setup)

**backend/vidpipe/orchestrator/:**
- Purpose: Pipeline execution orchestration
- Contains: State machine, step sequencing, resume point calculation
- Key files: `pipeline.py` (main orchestrator loop), `state.py` (state machine constants)

**backend/vidpipe/pipeline/:**
- Purpose: Individual pipeline step implementations
- Contains: Gemini/Imagen/Veo API calls, image/video generation, ffmpeg integration
- Key files: `storyboard.py`, `keyframes.py`, `video_gen.py`, `stitcher.py`

**backend/vidpipe/services/:**
- Purpose: Cross-cutting utilities
- Contains: Filesystem I/O, external API client factories
- Key files: `file_manager.py` (project directory structure), `vertex_client.py` (GCP client)

**frontend/src/api/:**
- Purpose: API client
- Contains: Fetch wrapper, request/response types matching backend Pydantic schemas
- Key files: `client.ts` (endpoint functions), `types.ts` (TypeScript types)

**frontend/src/components/:**
- Purpose: React component library
- Contains: Pages (GenerateForm, ProjectList, ProjectDetail, ProgressView, Dashboard) and components (SceneCard, StatusBadge, etc.)
- Organizational pattern: One component per file, lowercase with .tsx extension

**frontend/src/hooks/:**
- Purpose: Custom React hooks
- Contains: Status polling, generic polling logic
- Key files: `useProjectStatus.ts` (status polling with backoff), `usePolling.ts` (generic polling)

**tmp/:**
- Purpose: Artifact storage
- Contains: Per-project subdirectories with keyframes/, clips/, output/
- Structure: `tmp/{project_id}/keyframes/`, `tmp/{project_id}/clips/`, `tmp/{project_id}/output/`
- Generated: Yes, by `FileManager.get_project_dir()`
- Committed: No (in .gitignore)

## Key File Locations

**Entry Points:**
- Backend API: `backend/vidpipe/api/__main__.py` (run with `python -m vidpipe.api`)
- Frontend: `frontend/src/main.tsx` (Vite dev server with `npm run dev`)
- CLI (alternative): `backend/vidpipe/cli/__main__.py` (not used in main flow)

**Configuration:**
- Project config: `config.yaml` (models, pipeline params, storage paths)
- Environment: `.env` (Google Cloud project_id, credentials)
- Database: `backend/vidpipe/db/engine.py` (connection URL, PRAGMA settings)

**Core Logic:**
- API: `backend/vidpipe/api/routes.py` (POST /api/generate, GET /api/projects, POST /api/projects/{id}/fork, etc.)
- Orchestration: `backend/vidpipe/orchestrator/pipeline.py` (main pipeline loop)
- Storyboard: `backend/vidpipe/pipeline/storyboard.py` (Gemini structured output)
- Keyframes: `backend/vidpipe/pipeline/keyframes.py` (Imagen/Gemini image generation)
- Video Gen: `backend/vidpipe/pipeline/video_gen.py` (Veo video generation with polling)
- Stitcher: `backend/vidpipe/pipeline/stitcher.py` (ffmpeg video concatenation)

**Testing:**
- None currently present (not detected)

**Database Models:**
- All models: `backend/vidpipe/db/models.py` (Project, Scene, Keyframe, VideoClip, PipelineRun)

## Naming Conventions

**Files:**
- Python modules: `snake_case.py` (e.g., `file_manager.py`, `vertex_client.py`)
- React components: `PascalCase.tsx` (e.g., `GenerateForm.tsx`, `ProjectDetail.tsx`)
- Utility files: `camelCase.ts` (e.g., `useProjectStatus.ts`)

**Directories:**
- All lowercase with underscores: `api/`, `orchestrator/`, `file_manager/` (if directory)
- Feature directories: Named after feature (e.g., `components/`, `hooks/`, `services/`)

**Database Tables:**
- Plural nouns: `projects`, `scenes`, `keyframes`, `video_clips`, `pipeline_runs`

**ORM Model Classes:**
- Singular: `Project`, `Scene`, `Keyframe`, `VideoClip`, `PipelineRun`

**Pydantic Schemas:**
- Suffixes: `Request`, `Response`, `Output`, `Schema` (e.g., `GenerateRequest`, `GenerateResponse`, `StoryboardOutput`, `SceneSchema`)

**API Routes:**
- RESTful: `GET /api/projects`, `POST /api/generate`, `POST /api/projects/{id}/resume`
- Plural resource names: `/projects`, `/keyframes`, `/clips`

**Status Values:**
- Project/Scene status: lowercase (pending, storyboarding, keyframing, video_gen, stitching, complete, failed, stopped)

## Where to Add New Code

**New API Endpoint:**
- Implementation: `backend/vidpipe/api/routes.py` (add route handler with @router decorator)
- Schema: `backend/vidpipe/api/routes.py` (define Pydantic request/response class)
- Database: `backend/vidpipe/db/models.py` (if new table needed)

**New Pipeline Step:**
- Implementation: `backend/vidpipe/pipeline/{step_name}.py` (new module)
- Orchestration: `backend/vidpipe/orchestrator/pipeline.py` (add step in run_pipeline function)
- State: `backend/vidpipe/orchestrator/state.py` (add state to PIPELINE_STATES, STEP_TRANSITIONS)

**New React Component:**
- Page-level: `frontend/src/components/{ComponentName}.tsx`
- Reusable: `frontend/src/components/{ComponentName}.tsx`
- Hook: `frontend/src/hooks/use{HookName}.ts`

**New Configuration:**
- Project-wide: `config.yaml` (top-level key under appropriate section)
- Environment-specific: `.env` (use VIDPIPE_ prefix with __ delimiter)

**Shared Utilities:**
- Backend: `backend/vidpipe/services/{service_name}.py` or `backend/vidpipe/{utility_name}.py`
- Frontend: `frontend/src/lib/{utility_name}.ts`

**Database Schema Changes:**
- Model definition: `backend/vidpipe/db/models.py` (add/modify ORM class)
- Migration: Manual (no Alembic migration tool; schema auto-created on engine init)
- Note: Run `await init_database()` to create/update schema

## Special Directories

**backend/vidpipe.egg-info/:**
- Purpose: Python package metadata
- Generated: Yes (by `pip install -e .`)
- Committed: No

**.git/:**
- Purpose: Git version control
- Generated: Yes
- Committed: Yes

**frontend/dist/:**
- Purpose: Production build output
- Generated: Yes (by `npm run build`)
- Committed: No (in .gitignore)

**frontend/node_modules/:**
- Purpose: npm dependencies
- Generated: Yes (by `npm install`)
- Committed: No (in .gitignore)

**tmp/:**
- Purpose: Generated video artifacts (keyframes, clips, output)
- Generated: Yes (during pipeline execution)
- Committed: No (in .gitignore)

**.planning/phases/**:
- Purpose: Implementation phase specifications (not codebase structure)
- Generated: By GSD orchestrator
- Committed: Yes

---

*Structure analysis: 2026-02-16*
